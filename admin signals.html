<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление сигналами - Трейдинг Бот</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f172a;
            color: white;
            min-height: 100vh;
        }

        .signals-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 15px;
        }

        .signals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #334155;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f59e0b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-badge {
            background: #f59e0b;
            color: #0f172a;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-secondary {
            background: #374151;
            color: white;
            border: 1px solid #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .signals-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }

        .control-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-card:hover {
            transform: translateY(-2px);
            border-color: #3b82f6;
        }

        .control-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #60a5fa;
        }

        .control-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .control-desc {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .signals-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: #1e293b;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #334155;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #60a5fa;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .signals-list {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
            margin-bottom: 20px;
        }

        .signals-list h3 {
            margin-bottom: 15px;
            color: #e2e8f0;
        }

        .signal-item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            padding: 12px;
            background: #334155;
            border-radius: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .signal-pair {
            font-weight: 600;
            color: #60a5fa;
        }

        .signal-direction {
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.8rem;
        }

        .signal-buy {
            background: #10b981;
            color: white;
        }

        .signal-sell {
            background: #ef4444;
            color: white;
        }

        .signal-confidence {
            color: #f59e0b;
            font-weight: 500;
        }

        .signal-time {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .signal-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .ml-controls {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .ml-controls h3 {
            margin-bottom: 15px;
            color: #e2e8f0;
        }

        .ml-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .status-active {
            background: #10b981;
            color: white;
        }

        .status-pending {
            background: #f59e0b;
            color: white;
        }

        .status-completed {
            background: #6b7280;
            color: white;
        }
    </style>
</head>
<body>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.enableClosingConfirmation();

    function sendToBot(action, data = {}) {
        const payload = JSON.stringify({ action, ...data });
        tg.sendData(payload);
        showNotification(`Команда отправлена: ${action}`);
    }

    function showNotification(message) {
        const notification = document.getElementById('notification');
        if (notification) {
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Кнопка возврата
        const backBtn = document.getElementById('backBtn');
        if (backBtn) {
            backBtn.addEventListener('click', () => {
                window.location.href = 'admin.html';
            });
        }

        // Кнопка выхода
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                tg.close();
            });
        }

        // Загрузка данных сигналов
        loadSignalsData();
    });

    function loadSignalsData() {
        // Демо-данные сигналов
        updateSignalsList([
            {
                pair: 'EURUSD',
                direction: 'BUY',
                confidence: 8,
                price: 1.08542,
                time: '2 мин назад',
                status: 'active',
                source: 'SMC'
            },
            {
                pair: 'GBPUSD',
                direction: 'SELL',
                confidence: 7,
                price: 1.26518,
                time: '5 мин назад',
                status: 'completed',
                source: 'ML'
            },
            {
                pair: 'USDJPY',
                direction: 'BUY',
                confidence: 6,
                price: 148.923,
                time: '8 мин назад',
                status: 'completed',
                source: 'GPT'
            }
        ]);
    }

    function updateSignalsList(signals) {
        const container = document.getElementById('signalsList');
        if (!container) return;

        container.innerHTML = signals.map(signal => `
            <div class="signal-item">
                <div>
                    <div class="signal-pair">${signal.pair}</div>
                    <div class="signal-time">${signal.time} • ${signal.source}</div>
                </div>
                <div>
                    <span class="signal-direction ${signal.direction === 'BUY' ? 'signal-buy' : 'signal-sell'}">
                        ${signal.direction}
                    </span>
                    <div class="signal-confidence">${signal.confidence}/10</div>
                </div>
                <div class="signal-actions">
                    <span class="status-badge ${getStatusClass(signal.status)}">
                        ${getStatusText(signal.status)}
                    </span>
                    <button class="btn btn-small btn-primary" onclick="analyzePair('${signal.pair}')">
                        Анализ
                    </button>
                </div>
            </div>
        `).join('');
    }

    function getStatusClass(status) {
        switch(status) {
            case 'active': return 'status-active';
            case 'pending': return 'status-pending';
            case 'completed': return 'status-completed';
            default: return 'status-completed';
        }
    }

    function getStatusText(status) {
        switch(status) {
            case 'active': return 'Активна';
            case 'pending': return 'Ожидание';
            case 'completed': return 'Завершена';
            default: return 'Завершена';
        }
    }

    function analyzePair(pair) {
        sendToBot('analyze_pair', { pair: pair });
    }

    function forceSignal() {
        sendToBot('get_signal');
    }

    function testAllPairs() {
        sendToBot('test_all_pairs');
    }

    function clearSignals() {
        if (confirm('Очистить все сигналы?')) {
            sendToBot('clear_signals');
        }
    }
    </script>

    <div class="signals-container">
        <div class="signals-header">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-bolt"></i>
                    Управление сигналами
                </div>
                <div class="admin-badge">АДМИНИСТРАТОР</div>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" id="backBtn">
                    <i class="fas fa-arrow-left"></i>
                    Панель
                </button>
                <button class="btn btn-danger" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Выйти
                </button>
            </div>
        </div>

        <div class="signals-stats">
            <div class="stat-card">
                <div class="stat-value" id="totalSignals">24</div>
                <div class="stat-label">Всего сигналов</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeSignals">3</div>
                <div class="stat-label">Активных</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successRate">68%</div>
                <div class="stat-label">Успешность</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgConfidence">7.2</div>
                <div class="stat-label">Средняя уверенность</div>
            </div>
        </div>

        <div class="signals-controls">
            <div class="control-card" onclick="forceSignal()">
                <div class="control-icon">
                    <i class="fas fa-search"></i>
                </div>
                <div class="control-title">Принудительный поиск</div>
                <div class="control-desc">Запуск поиска сигналов по всем парам</div>
            </div>
            
            <div class="control-card" onclick="testAllPairs()">
                <div class="control-icon">
                    <i class="fas fa-vial"></i>
                </div>
                <div class="control-title">Тест всех пар</div>
                <div class="control-desc">Анализ всех торговых пар</div>
            </div>
            
            <div class="control-card" onclick="sendToBot('repairml')">
                <div class="control-icon">
                    <i class="fas fa-tools"></i>
                </div>
                <div class="control-title">Восстановить ML</div>
                <div class="control-desc">Восстановление ML фичей</div>
            </div>
            
            <div class="control-card" onclick="clearSignals()">
                <div class="control-icon">
                    <i class="fas fa-broom"></i>
                </div>
                <div class="control-title">Очистить сигналы</div>
                <div class="control-desc">Очистка истории сигналов</div>
            </div>
        </div>

        <div class="signals-list">
            <h3>Последние сигналы</h3>
            <div id="signalsList">
                <!-- Сигналы будут загружены через JavaScript -->
            </div>
        </div>

        <div class="ml-controls">
            <h3>Управление ML моделью</h3>
            <div class="ml-actions">
                <button class="btn btn-primary" onclick="sendToBot('modelstats')">
                    <i class="fas fa-chart-bar"></i>
                    Статистика ML
                </button>
                <button class="btn btn-success" onclick="sendToBot('retrain')">
                    <i class="fas fa-retweet"></i>
                    Переобучить
                </button>
                <button class="btn btn-secondary" onclick="sendToBot('forceml')">
                    <i class="fas fa-power-off"></i>
                    Принудительно ВКЛ
                </button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>
</body>
</html>
