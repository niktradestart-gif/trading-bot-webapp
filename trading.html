<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>ASPIRE TRADE — Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <meta name="theme-color" content="#0b0f19"/>
  <style>
    :root{
      --bg:#0b0f19;
      --card1:rgba(20,26,48,.72);
      --card2:rgba(15,19,34,.86);
      --muted:#8d95af;
      --text:#e9ecf5;
      --good:#27e0a1;
      --bad:#ff5c7a;
      --accent:#5aa6ff;
      --accent2:#7b5bff;
      --border:rgba(255,255,255,.06);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;
      background:
        radial-gradient(1200px 600px at 50% -10%, rgba(90,166,255,.08), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
    }

    .wrap{min-height:100dvh;display:flex;flex-direction:column;gap:14px;padding:16px 14px 24px;align-items:center}
    .topbar{width:100%;max-width:900px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.5px}
    .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 0 18px rgba(122,139,255,.6)}
    .userbox{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
    .logout{
      font-size:12px;padding:7px 12px;border-radius:999px;border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(20,26,48,.65), rgba(15,19,34,.82));
      color:var(--text);text-decoration:none;cursor:pointer;transition:.2s;backdrop-filter:blur(6px)
    }
    .logout:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,0,0,.25)}

    .grid{width:100%;max-width:900px;display:grid;grid-template-columns:1fr;gap:14px}

    .card{
      background:linear-gradient(180deg, var(--card1), var(--card2));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card__inner{padding:14px}
    .title{font-size:18px;font-weight:800;letter-spacing:.3px;margin:0 0 8px 0;display:flex;gap:8px;align-items:center}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .center{display:flex;flex-direction:column;align-items:center;gap:12px}

    .chart-wrap{
      width:100%;
      max-width:760px;
      aspect-ratio:16/10;
      border-radius:12px;
      overflow:hidden;
      background:#0b0f19;
      border:1px solid var(--border);
      position:relative;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    .chart{width:100%;height:100%;display:block;object-fit:cover}
    .chart--hidden{display:none}

    .signal{width:100%;display:grid;gap:8px;grid-template-columns:repeat(2,minmax(0,1fr))}
    .item{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:12px;padding:10px 12px;display:flex;flex-direction:column;gap:4px}
    .label{font-size:12px;color:var(--muted)}
    .val{font-size:16px;font-weight:800}
    .val.buy{color:var(--good)}
    .val.sell{color:var(--bad)}
    .val.em{color:var(--accent)}

    .timerBox{width:100%;max-width:760px;display:flex;flex-direction:column;gap:8px;align-items:center}
    .timerText{font-variant-numeric:tabular-nums;font-size:18px;font-weight:800;letter-spacing:.5px}
    .bar{width:100%;height:10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.05);overflow:hidden;position:relative;box-shadow:inset 0 0 0 1px rgba(255,255,255,.02)}
    .bar__fill{position:absolute;left:0;top:0;bottom:0;width:100%;background:linear-gradient(90deg, var(--accent2), var(--accent));box-shadow:0 0 12px rgba(123,91,255,.35);transition:width .25s linear}

    .deal{
      width:100%;max-width:760px;
      background:linear-gradient(180deg, rgba(25,13,20,.75), rgba(20,12,18,.92));
      border:1px solid rgba(255,92,122,.35);
      border-radius:14px;padding:16px;
      display:none;animation:.35s ease fadeIn;box-shadow:0 10px 30px rgba(255,92,122,.18)
    }
    .deal.win{background:linear-gradient(180deg, rgba(17,33,28,.75), rgba(14,26,23,.92));border:1px solid rgba(39,224,161,.35);box-shadow:0 10px 30px rgba(39,224,161,.18)}
    .deal .h{display:flex;align-items:center;gap:8px;font-weight:900;letter-spacing:.4px}
    .deal .h .dot{width:10px;height:10px;background:var(--bad)}
    .deal.win .h .dot{background:var(--good)}
    .rows{margin-top:10px;display:grid;gap:8px;grid-template-columns:repeat(2,minmax(0,1fr))}
    .r{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    .r .label{font-size:12px;color:var(--muted)}
    .r .val{font-weight:800;font-size:16px}
    .fade-in{animation:.3s ease fadeIn}
    @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
    .hide{display:none!important}

    @media (max-width:480px){
      .title{font-size:16px}
      .signal{grid-template-columns:1fr 1fr}
      .rows{grid-template-columns:1fr 1fr}
      .logout{padding:6px 10px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand"><span class="dot"></span><span>ASPIRE TRADE</span></div>
      <div class="userbox">
        <span id="userId">ID: —</span>
        <button class="logout" id="logoutBtn">Выйти</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card__inner center">

          <h3 class="title">ТЕКУЩИЙ СИГНАЛ <span id="sigSource" class="badge">—</span></h3>

          <div class="chart-wrap">
            <img id="chartImg" class="chart" alt="chart">
          </div>

          <div class="signal">
            <div class="item"><div class="label">Пара</div><div id="pair" class="val em">—</div></div>
            <div class="item"><div class="label">Направление</div><div id="direction" class="val">—</div></div>
            <div class="item"><div class="label">Вход</div><div id="entry" class="val">—</div></div>
            <div class="item"><div class="label">Экспирация</div><div id="expiry" class="val">—</div></div>
          </div>

          <div class="timerBox">
            <div id="timerText" class="timerText">⏳ —:—</div>
            <div class="bar"><div id="barFill" class="bar__fill" style="width:100%"></div></div>
          </div>

          <div id="dealCard" class="deal">
            <div class="h"><span class="dot"></span><span id="dealTitle">СДЕЛКА ЗАВЕРШЕНА</span></div>
            <div class="rows">
              <div class="r"><div class="label">Пара</div><div id="d_pair" class="val">—</div></div>
              <div class="r"><div class="label">Направление</div><div id="d_dir" class="val">—</div></div>
              <div class="r"><div class="label">Вход</div><div id="d_entry" class="val">—</div></div>
              <div class="r"><div class="label">Выход</div><div id="d_exit" class="val">—</div></div>
              <div class="r" style="grid-column:1/-1"><div class="label">Результат</div><div id="d_res" class="val">—</div></div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const state = {
    apiBase: window.location.origin,      // сохраняем твою логику, но делаем универсально (ngrok/localhost)
    pollMs: 5000,
    lastSignalTs: 0,
    lastTradeIdShown: null,
    timerInt: null,
    totalMs: 0,
    expiryMs: 0,
  };

  const el = s => document.querySelector(s);
  const pad = x => String(x).padStart(2,'0');
  const fmt = n => (n===null||n===undefined) ? "—" : (typeof n==="number" ? (Math.abs(n) >= 1 ? n.toFixed(5) : n.toPrecision(6)) : n);

  // -------- header: user id + logout
  async function initHeader(){
    let uid = localStorage.getItem('user_id') || localStorage.getItem('uid') || null;

    if(!uid){
      // пытаемся прочитать pocket_users.json (сначала /api/, потом корень)
      try{
        let r = await fetch(`${state.apiBase}/api/pocket_users.json`, {cache:'no-store'});
        if(!r.ok) throw 0;
        const j = await r.json();
        uid = extractUserIdFromPocket(j);
      }catch(_){
        try{
          let r2 = await fetch(`${state.apiBase}/pocket_users.json`, {cache:'no-store'});
          if(r2.ok){
            const j2 = await r2.json();
            uid = extractUserIdFromPocket(j2);
          }
        }catch(__){}
      }
    }

    el('#userId').textContent = `ID: ${uid || '—'}`;
    el('#logoutBtn').addEventListener('click', ()=>{
      try{ localStorage.clear(); }catch(_){}
      setTimeout(()=>{ location.href = 'login.html'; }, 80);
    });
  }

  function extractUserIdFromPocket(obj){
    // ожидается структура вида: { users: [{id: ... , ...}, ...] } или { "5129282647": {...}, ... }
    try{
      if(Array.isArray(obj?.users) && obj.users.length){
        // если есть флаг "current" — берём его, иначе первого
        const current = obj.users.find(u => u.current || u.active);
        return String((current || obj.users[0]).id || '');
      }
      const keys = Object.keys(obj||{});
      if(keys.length){ return String(keys[0]); }
    }catch(_){}
    return null;
  }

  // -------- helpers
  function setChartVisible(v){
    const img = el('#chartImg');
    if(v) img.classList.remove('chart--hidden'); else img.classList.add('chart--hidden');
  }
  function setDealVisible(v, isWin=false){
    const card = el('#dealCard');
    if(v){
      card.style.display = 'block';
      card.classList.add('fade-in');
      isWin ? card.classList.add('win') : card.classList.remove('win');
    }else{
      card.style.display = 'none';
      card.classList.remove('win');
    }
  }

  function startTimer(createdTs, expiryMinutes){
    clearInterval(state.timerInt);

    if(!createdTs || !expiryMinutes){
      el('#timerText').textContent = '⏳ —:—';
      el('#barFill').style.width = '0%';
      return;
    }

    const createdMs = (typeof createdTs === 'number') ? createdTs : new Date(createdTs).getTime();
    const expiryMs  = createdMs + (expiryMinutes * 60 * 1000);
    const totalMs   = Math.max(1, expiryMs - createdMs);

    state.expiryMs = expiryMs;
    state.totalMs  = totalMs;

    const tick = () => {
      const now = Date.now();
      const rem = Math.max(0, expiryMs - now);
      const mm = Math.floor(rem/1000/60);
      const ss = Math.floor(rem/1000) % 60;
      el('#timerText').textContent = `⏳ Осталось: ${pad(mm)}:${pad(ss)}`;

      const pct = Math.max(0, Math.min(100, (rem / totalMs) * 100));
      el('#barFill').style.width = `${pct}%`;

      if(rem<=0){
        clearInterval(state.timerInt);
      }
    };

    tick();
    state.timerInt = setInterval(tick, 250);
  }

  // -------- renderers (сохраняем твою структуру latest_full.json)
  function renderSignal(sig, chartBase64){
    // показать график, скрыть завершенную сделку
    setDealVisible(false);
    setChartVisible(true);

    el('#sigSource').textContent = sig?.source ?? '—';
    el('#pair').textContent      = sig?.pair ?? '—';

    const dir = String(sig?.direction||'—').toUpperCase();
    const dirEl = el('#direction');
    dirEl.textContent = dir;
    dirEl.classList.remove('buy','sell');
    if(dir==='BUY')  dirEl.classList.add('buy');
    if(dir==='SELL') dirEl.classList.add('sell');

    // у тебя приходит entry_price
    el('#entry').textContent = fmt(sig?.entry_price ?? sig?.entry);

    // expiry — это минуты; метка времени — timestamp (ISO/число)
    const createdTs = sig?.timestamp ?? sig?.created_at ?? Date.now();
    const expMin    = sig?.expiry ?? sig?.expiry_minutes ?? null;
    if(createdTs && expMin){
      const expAt = new Date((typeof createdTs==='number'?createdTs:new Date(createdTs).getTime()) + expMin*60*1000);
      el('#expiry').textContent = expAt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      startTimer(createdTs, expMin);
    }else{
      el('#expiry').textContent = '—';
      startTimer(null, null);
    }

    // график — из chart_base64
    if(chartBase64){
      el('#chartImg').src = chartBase64.startsWith("data:image") 
        ? chartBase64 
        : `data:image/png;base64,${chartBase64}`;
    }
  }

  function renderCompleted(res){
    const id   = res?.trade_id ?? '—';
    const pair = res?.pair ?? '—';
    const dir  = res?.direction ? String(res.direction).toUpperCase() : '—';
    const entry= res?.entry_price ?? res?.entry ?? '—';
    const exit = res?.exit_price  ?? res?.exit  ?? '—';
    const result = (res?.result || '—').toUpperCase();

    const prefix = (result==='WIN') ? '🟢 СДЕЛКА #' : '🔴 СДЕЛКА #';
    el('#dealTitle').textContent = `${prefix}${id} ЗАВЕРШЕНА`;

    el('#d_pair').textContent  = pair;
    el('#d_dir').textContent   = dir;
    el('#d_entry').textContent = fmt(entry);
    el('#d_exit').textContent  = fmt(exit);
    el('#d_res').textContent   = result;

    // скрыть график, показать карточку
    setChartVisible(false);
    setDealVisible(true, result==='WIN');

    // остановить таймер
    clearInterval(state.timerInt);
    el('#timerText').textContent = '⏳ —:—';
    el('#barFill').style.width = '0%';
  }

  // -------- fetch & decide
  async function loadLatest(){
    try{
      const r = await fetch(`${state.apiBase}/api/latest_full.json`, {cache:'no-store'});
      if(!r.ok) throw new Error('bad latest_full');
      const data = await r.json();

      // ожидается твоя структура:
      // { signal: { pair, direction, entry_price, expiry, timestamp, ... }, result: {...}, chart_base64: "..." }
      const sig = data?.signal || null;
      const res = data?.result || null;
      const chartB64 = data?.chart_base64 || null;

      // если есть активный сигнал — показываем его; иначе — результат, если есть
      let showSignal = false;
      if(sig){
        const created = sig?.timestamp ?? sig?.created_at ?? null;
        const expMin  = sig?.expiry ?? sig?.expiry_minutes ?? null;
        if(created && expMin){
          const createdMs = (typeof created==='number') ? created : new Date(created).getTime();
          const expMs = createdMs + expMin*60*1000;
          showSignal = expMs > Date.now();
        }
      }

      if(showSignal){
        // ререндер только если новый штамп
        const stamp = sig?.timestamp ? (typeof sig.timestamp==='number' ? sig.timestamp : new Date(sig.timestamp).getTime())
                                     : (sig?.created_at ? new Date(sig.created_at).getTime() : Date.now());
        if (stamp !== state.lastSignalTs){
          state.lastSignalTs = stamp;
          renderSignal(sig, chartB64);
        } else {
          // обновим таймер без перерисовки
          startTimer(sig?.timestamp ?? sig?.created_at ?? null, sig?.expiry ?? sig?.expiry_minutes ?? null);
        }
      }else if(res){
        if(res.trade_id !== state.lastTradeIdShown){
          state.lastTradeIdShown = res.trade_id;
          renderCompleted(res);
        }
      }else{
        // ни сигнала, ни результата — просто ждём
      }
    }catch(e){
      console.warn(e);
    }
  }

  async function boot(){
    await initHeader();
    loadLatest();
    setInterval(loadLatest, state.pollMs);
  }

  window.addEventListener('load', boot);
})();
</script>
</body>
</html>
