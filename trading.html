<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ASPIRE TRADE ‚Äî Trading</title>
  <style>
    :root{
      --bg:#0b0c14; --panel:#111225; --panel-2:#14162c; --text:#f4f6ff;
      --muted:#aab0c5; --accent1:#6b5cff; --accent2:#19c3ff; --win:#18d27c; --loss:#ff5c7a;
      --glass: rgba(255,255,255,.07);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% -10%, #2c186e44 0%, transparent 60%),
        radial-gradient(900px 500px at 85% 110%, #0d476a44 0%, transparent 60%),
        linear-gradient(180deg,#0b0c14 0%, #0b0c14 100%);
      background-color:var(--bg);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:20px 16px 40px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;
    }
    .brand{
      display:flex;align-items:center;gap:12px;font-weight:700;letter-spacing:.4px;
    }
    .badge{
      font-size:.75rem;color:#d5d8ff;background:linear-gradient(90deg,var(--accent1),var(--accent2));
      padding:4px 10px;border-radius:999px;box-shadow:0 0 16px #6b5cff55;
    }
    .actions{display:flex;gap:10px}
    button{
      background:linear-gradient(90deg,var(--accent1),var(--accent2));
      border:none;color:#fff;font-weight:700;padding:10px 16px;border-radius:10px;cursor:pointer;
      box-shadow:0 6px 18px #1a36ff44; transition:transform .15s ease, box-shadow .2s ease, opacity .15s ease;
    }
    button:hover{transform:translateY(-1px); box-shadow:0 10px 24px #1a36ff55}
    button.secondary{
      background:transparent;border:1px solid #3d4270;color:#e3e7ff;box-shadow:none;
    }
    button.danger{
      background:linear-gradient(90deg,#ff5c7a,#f98a52);
      box-shadow:0 6px 18px #ff5c7a55;
    }

    .grid{display:grid;gap:16px;grid-template-columns:1.1fr .9fr}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%);
      border:1px solid #2a2e55;border-radius:16px;padding:16px;
      box-shadow:0 10px 40px #00000060, 0 0 0 1px #1c2040 inset;
      backdrop-filter: blur(8px);
    }
    .hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .hd h3{margin:0;font-size:1.05rem;color:#e5e7ff}
    .muted{color:var(--muted);font-size:.9rem}
    .signal{
      display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:6px;
    }
    .kv{background:var(--glass);border:1px solid #2a2e55;border-radius:12px;padding:12px}
    .kv .k{font-size:.8rem;color:var(--muted)}
    .kv .v{font-size:1.05rem;margin-top:2px}
    .dir-buy{color:var(--win)} .dir-sell{color:var(--loss)}
    .chart{
      width:100%;aspect-ratio:16/9;border-radius:12px;object-fit:contain;background:#0c0e1d;border:1px solid #2a2e55;
      box-shadow:inset 0 0 0 1px #1a1d38;
    }

    .stats{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .stat{background:var(--glass);border:1px solid #2a2e55;border-radius:12px;padding:12px}
    .stat .label{font-size:.78rem;color:var(--muted)}
    .stat .val{font-size:1.2rem;margin-top:4px}

    .history{width:100%;border-collapse:collapse;font-size:.95rem}
    .history th,.history td{padding:10px;border-bottom:1px dashed #2a2e55;text-align:left}
    .history th{color:#bfc6ff;font-weight:600}
    .chip{font-size:.78rem;padding:3px 8px;border-radius:999px;border:1px solid #2a2e55;background:#141636;color:#dfe3ff}
    .chip.win{border-color:#1f945d;color:#aff3d1;background:#10251d}
    .chip.loss{border-color:#9b3653;color:#ffd5df;background:#2a111a}

    .footnote{margin-top:14px;color:var(--muted);font-size:.85rem}
    .blink{animation:blink 1.2s linear infinite}
    @keyframes blink{50%{opacity:.45}}
    .error{color:#ff8da3}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span style="width:12px;height:12px;border-radius:50%;background:linear-gradient(180deg,var(--accent1),var(--accent2));box-shadow:0 0 16px #6b5cff88;"></span>
        <div>ASPIRE TRADE ‚Äî <span class="muted">dashboard</span></div>
        <span id="liveBadge" class="badge">LIVE</span>
      </div>
      <div class="actions">
        <button class="secondary" id="btnRefresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="danger" id="btnLogout">–í—ã—Ö–æ–¥</button>
      </div>
    </div>

    <div class="grid">
      <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
      <div class="card">
        <div class="hd">
          <h3>üìà –ê–∫—Ç–∏–≤–Ω—ã–π —Å–∏–≥–Ω–∞–ª</h3>
          <div class="muted" id="updatedAt">‚Äî</div>
        </div>

        <div id="signalArea">
          <div class="signal">
            <div class="kv">
              <div class="k">–ü–∞—Ä–∞</div>
              <div class="v" id="pair">‚Äî</div>
            </div>
            <div class="kv">
              <div class="k">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
              <div class="v" id="direction">‚Äî</div>
            </div>
            <div class="kv">
              <div class="k">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
              <div class="v" id="confidence">‚Äî</div>
            </div>
            <div class="kv">
              <div class="k">–≠–∫—Å–ø–∏—Ä–∞—Ü–∏—è</div>
              <div class="v" id="expiry">‚Äî</div>
            </div>
            <div class="kv">
              <div class="k">–ò—Å—Ç–æ—á–Ω–∏–∫</div>
              <div class="v" id="source">‚Äî</div>
            </div>
            <div class="kv">
              <div class="k">–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞</div>
              <div class="v" id="entry">‚Äî</div>
            </div>
          </div>

          <div style="margin-top:14px">
            <img id="chart" class="chart" alt="chart"/>
          </div>

          <div class="footnote" id="signalNote">–û–∂–∏–¥–∞–µ–º –Ω–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª‚Ä¶</div>
          <div class="error" id="signalError" style="display:none"></div>
        </div>
      </div>

      <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
      <div class="card">
        <div class="hd">
          <h3>üìä –°–∏—Å—Ç–µ–º–∞</h3>
          <div class="muted" id="sysUpdated">‚Äî</div>
        </div>

        <div class="stats" style="margin-bottom:14px">
          <div class="stat">
            <div class="label">Win Rate</div>
            <div class="val" id="winRate">‚Äî</div>
          </div>
          <div class="stat">
            <div class="label">ML Accuracy</div>
            <div class="val" id="mlAcc">‚Äî</div>
          </div>
          <div class="stat">
            <div class="label">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div>
            <div class="val" id="totalTrades">‚Äî</div>
          </div>
          <div class="stat">
            <div class="label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            <div class="val" id="activeUsers">‚Äî</div>
          </div>
        </div>

        <div class="hd" style="margin-top:18px">
          <h3>üïí –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h3>
          <div></div>
        </div>
        <table class="history">
          <thead>
            <tr>
              <th>–ü–∞—Ä–∞</th>
              <th>–ù–∞–ø—Ä.</th>
              <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
              <th>–í—Ä–µ–º—è</th>
            </tr>
          </thead>
          <tbody id="lastResultTbody">
            <tr><td colspan="4" class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="footnote">–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ <span class="blink">‚óè</span></div>
  </div>

  <script>
    // === CONFIG ===
    const API = "http://89.23.98.206:8080";
    const POLL_MS = 5000;

    // === AUTH GUARD (–µ—Å–ª–∏ –ª–æ–≥–∏–Ω –µ—Å—Ç—å) ===
    (function authGuard(){
      const uid = localStorage.getItem("pocket_id");
      if(!uid){
        // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ –ª–æ–≥–∏–Ω
        // window.location.href = "login.html";
      }
    })();

    // === UI ELEMENTS ===
    const el = {
      pair: document.querySelector('#pair'),
      direction: document.querySelector('#direction'),
      confidence: document.querySelector('#confidence'),
      expiry: document.querySelector('#expiry'),
      source: document.querySelector('#source'),
      entry: document.querySelector('#entry'),
      chart: document.querySelector('#chart'),
      note: document.querySelector('#signalNote'),
      err: document.querySelector('#signalError'),
      updatedAt: document.querySelector('#updatedAt'),
      sysUpdated: document.querySelector('#sysUpdated'),
      winRate: document.querySelector('#winRate'),
      mlAcc: document.querySelector('#mlAcc'),
      totalTrades: document.querySelector('#totalTrades'),
      activeUsers: document.querySelector('#activeUsers'),
      lastResultTbody: document.querySelector('#lastResultTbody'),
      liveBadge: document.querySelector('#liveBadge'),
      btnRefresh: document.querySelector('#btnRefresh'),
      btnLogout: document.querySelector('#btnLogout'),
    };

    // === HELPERS ===
    const fmtPct = v => (v == null || isNaN(v)) ? '‚Äî' : (v.toFixed ? v.toFixed(2) : v) + '%';
    const nowText = () => new Date().toLocaleTimeString();

    function setSignalEmpty(reason){
      el.pair.textContent = '‚Äî';
      el.direction.textContent = '‚Äî';
      el.direction.classList.remove('dir-buy','dir-sell');
      el.confidence.textContent = '‚Äî';
      el.expiry.textContent = '‚Äî';
      el.source.textContent = '‚Äî';
      el.entry.textContent = '‚Äî';
      el.chart.removeAttribute('src');
      el.note.textContent = reason || '–û–∂–∏–¥–∞–µ–º –Ω–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª‚Ä¶';
      el.err.style.display = 'none';
    }

    function setResultEmpty(){
      el.lastResultTbody.innerHTML = `<tr><td colspan="4" class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
    }

    async function fetchJSON(url){
      try {
        const r = await fetch(url, {cache: 'no-store'});
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
      } catch (error) {
        console.error('Fetch error:', error);
        throw error;
      }
    }

    async function loadAll(){
      try{
        console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
        const data = await fetchJSON(`${API}/api/latest_full.json?ts=${Date.now()}`);
        console.log('üìä –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);

        // --- System ---
        const sys = data.system || {};
        console.log('üìà –°–∏—Å—Ç–µ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', sys);
        
        el.winRate.textContent = fmtPct(sys.win_rate);
        el.mlAcc.textContent = fmtPct(sys.ml_accuracy);
        el.totalTrades.textContent = sys.total_trades ?? '‚Äî';
        el.activeUsers.textContent = sys.active_users ?? '‚Äî';
        el.sysUpdated.textContent = nowText();

        // --- Signal ---
        console.log('üì° –î–∞–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª–∞:', data.signal);
        if(data.signal && !data.signal.error){
          const s = data.signal;
          console.log('üéØ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–∞:', s);
          
          el.pair.textContent = s.pair || '‚Äî';
          el.direction.textContent = s.direction || '‚Äî';
          el.direction.classList.remove('dir-buy','dir-sell');
          if(s.direction){
            el.direction.classList.add(s.direction.toUpperCase() === 'BUY' ? 'dir-buy' : 'dir-sell');
          }
          el.confidence.textContent = (s.confidence != null ? s.confidence : '‚Äî') + (s.confidence != null ? '/10' : '');
          
          // üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ undefined –¥–ª—è expiry
          el.expiry.textContent = (s.expiry != null ? s.expiry : '‚Äî') + ' –º–∏–Ω';
          
          el.source.textContent = s.source || '‚Äî';
          el.entry.textContent = (s.entry_price != null) ? Number(s.entry_price).toFixed(5) : '‚Äî';
          el.note.textContent = '–°–∏–≥–Ω–∞–ª –∞–∫—Ç–∏–≤–µ–Ω';
          el.err.style.display = 'none';

          // –≥—Ä–∞—Ñ–∏–∫
          if(data.chart_base64){
            el.chart.src = data.chart_base64;
          } else {
            el.chart.src = `${API}/api/chart.png?ts=${Date.now()}`;
          }
        } else {
          console.log('‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞');
          setSignalEmpty('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤');
        }
        el.updatedAt.textContent = nowText();

        // --- Last Result ---
        console.log('üìä –î–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', data.result);
        if(data.result && !data.result.error){
          const r = data.result;
          console.log('üéØ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', r);
          
          // üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
          el.lastResultTbody.innerHTML = `
            <tr>
              <td>${r.pair || '‚Äî'}</td>
              <td>${r.direction || '‚Äî'}</td>
              <td>
                <span class="chip ${r.result === 'WIN' ? 'win' : 'loss'}">${r.result || '‚Äî'}</span>
              </td>
              <td>${r.time || r.completed_at || '‚Äî'}</td>
            </tr>
          `;
        } else {
          console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ');
          setResultEmpty();
        }

        // live badge
        el.liveBadge.textContent = 'LIVE';
        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');

      } catch(err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', err);
        el.err.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + (err.message || err);
        el.err.style.display = 'block';
        el.liveBadge.textContent = 'OFFLINE';
      }
    }

    // === EVENTS ===
    el.btnRefresh.addEventListener('click', loadAll);
    el.btnLogout.addEventListener('click', ()=>{
      localStorage.clear();
      window.location.href = 'login.html';
    });

    // === INIT ===
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞...');
    loadAll();
    setInterval(loadAll, POLL_MS);
  </script>
</body>
</html>
