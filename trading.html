<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ASPIRE TRADE ‚Äî –ü–∞–Ω–µ–ª—å</title>

  <!-- –ì—Ä–∞–¥–∏–µ–Ω—Ç + —Å—Ç–µ–∫–ª–æ, –∫–∞–∫ –Ω–∞ —Ç–≤–æ–∏—Ö —Å–∫—Ä–∏–Ω–∞—Ö -->
  <style>
    :root{
      --bg1:#0b1027;--bg2:#11183a;--accent1:#6417ff;--accent2:#17d8ff;
      --glass:rgba(255,255,255,0.08);--b1:rgba(255,255,255,0.12);--txt:#e9ecff;
      --ok:#00e676;--warn:#ffb300;--err:#ff5252;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt);
      background: radial-gradient(1200px 700px at 10% 15%, #1d2b6b 0%, transparent 60%),
                  radial-gradient(1000px 800px at 90% 20%, #4d1a9b 0%, transparent 60%),
                  radial-gradient(1400px 1000px at 40% 80%, #04203f 0%, transparent 60%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    .grid{
      max-width:1200px;margin:26px auto;padding:0 16px;
      display:grid;grid-template-columns:repeat(12,1fr);gap:18px;
    }
    .header{
      grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;
      padding:14px 18px;border-radius:14px;background:var(--glass);backdrop-filter: blur(12px);
      border:1px solid var(--b1);box-shadow:0 8px 30px rgba(100,23,255,.15);
    }
    .logo{font-weight:800;letter-spacing:.6px}
    .logo span{color:#b78cff;text-shadow:0 0 10px rgba(183,140,255,.6)}
    .btn{
      background:linear-gradient(90deg,var(--accent1),var(--accent2));
      color:#fff;border:none;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer;
      box-shadow:0 0 12px rgba(23,216,255,.35);transition:.25s;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 0 16px rgba(23,216,255,.55)}
    .card{
      background:var(--glass);backdrop-filter: blur(10px);
      border:1px solid var(--b1);border-radius:14px;padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.02);
      animation:fade .5s ease both;
    }
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    h3{margin:0 0 10px 0;font-weight:800;letter-spacing:.3px}
    .neon{color:#b78cff;text-shadow:0 0 10px rgba(183,140,255,.55)}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;font-weight:700;font-size:.9rem}
    .ok{background:rgba(0,230,118,.12);border:1px solid rgba(0,230,118,.35);color:var(--ok)}
    .warn{background:rgba(255,179,0,.12);border:1px solid rgba(255,179,0,.35);color:var(--warn)}
    .err{background:rgba(255,82,82,.12);border:1px solid rgba(255,82,82,.35);color:var(--err)}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
    .kpi .label{opacity:.75;font-size:.9rem}
    .kpi .val{font-size:1.8rem;font-weight:900;margin-top:6px}
    .muted{opacity:.7}
    .signal-box{font-size:1.06rem;line-height:1.6}
    .signal-row{display:flex;gap:12px;flex-wrap:wrap}
    .chip{background:rgba(255,255,255,.08);border:1px solid var(--b1);border-radius:999px;padding:6px 10px}
    .dir-buy{color:#5dffa7}.dir-sell{color:#ff7a7a}
    .chart{width:100%;border-radius:12px;margin-top:12px;border:1px solid var(--b1)}
    .table{width:100%;border-collapse:collapse;margin-top:6px;font-size:.95rem}
    .table th,.table td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    .table th{opacity:.8;font-weight:700}
    .mono{font-variant-numeric:tabular-nums}
    /* layout columns */
    .col-12{grid-column:span 12}
    .col-8{grid-column:span 8}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    @media (max-width:980px){.kpis{grid-template-columns:repeat(2,1fr)}.col-8,.col-6{grid-column:span 12}.col-4{grid-column:span 12}}
  </style>
</head>
<body>
  <div class="grid">
    <!-- Header -->
    <div class="header">
      <div class="logo">ASPIRE <span>TRADE</span></div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="status-pill" class="pill warn">–°—Ç–∞—Ç—É—Å: ‚Äî</div>
        <button class="btn" onclick="logout()">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="card col-12">
      <div class="kpis">
        <div class="kpi">
          <div class="label">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
          <div id="kpi-users" class="val mono">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="label">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div>
          <div id="kpi-trades" class="val mono">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="label">Win Rate</div>
          <div id="kpi-win" class="val mono">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="label">ML –¢–æ—á–Ω–æ—Å—Ç—å</div>
          <div id="kpi-ml" class="val mono">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- Signal + Chart -->
    <div class="card col-8">
      <h3 class="neon">‚ö° –ê–∫—Ç–∏–≤–Ω—ã–π —Å–∏–≥–Ω–∞–ª</h3>
      <div id="signal-box" class="signal-box">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      <img id="chart" class="chart" alt="Chart" />
    </div>

    <!-- Last result -->
    <div class="card col-4">
      <h3 class="neon">üìà –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h3>
      <div id="result-box" class="signal-box">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </div>

    <!-- History -->
    <div class="card col-12">
      <h3 class="neon">üïí –ò—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)</h3>
      <table class="table">
        <thead>
          <tr><th>#</th><th>–ü–∞—Ä–∞</th><th>–ù–∞–ø—Ä.</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–í—Ö–æ–¥</th><th>–í—ã—Ö–æ–¥</th><th>–í—Ä–µ–º—è</th></tr>
        </thead>
        <tbody id="hist-body"><tr><td colspan="7" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr></tbody>
      </table>
    </div>
  </div>

  <script>
    // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
    const API_BASE = "http://89.23.98.206:8080";
    const FULL_URL = API_BASE + "/api/latest_full.json";
    const HIST_URL = API_BASE + "/api/trade_history.json"; // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (–µ—Å–ª–∏ –¥–æ–±–∞–≤–∏—à—å –≤ API)
    const REFRESH_MS = 5000;

    function logout(){
      try{localStorage.clear()}catch(e){}
      location.href = "login.html";
    }

    function setStatus(ok){
      const pill = document.getElementById("status-pill");
      if(!pill) return;
      pill.classList.remove("ok","warn","err");
      pill.classList.add(ok ? "ok" : "warn");
      pill.textContent = ok ? "–°—Ç–∞—Ç—É—Å: ONLINE" : "–°—Ç–∞—Ç—É—Å: ‚Äî";
    }

    function fmt(n, p=5){
      const v = (typeof n === "number") ? n : parseFloat(n);
      if(isNaN(v)) return "‚Äî";
      return v.toFixed(p);
    }

    function dirClass(d){ return (d||"").toUpperCase()==="BUY" ? "dir-buy" : "dir-sell"; }

    async function loadFull(){
      try{
        const res = await fetch(FULL_URL + "?t=" + Date.now());
        const data = await res.json();

        // === kpis ===
        const sys = data?.system || {};
        document.getElementById("kpi-users").textContent = sys.active_users ?? "‚Äî";
        document.getElementById("kpi-trades").textContent = sys.total_trades ?? "‚Äî";
        document.getElementById("kpi-win").textContent = (sys.win_rate!=null? sys.win_rate+"%":"‚Äî");
        document.getElementById("kpi-ml").textContent = (sys.ml_accuracy!=null? sys.ml_accuracy+"%":"‚Äî");
        setStatus(true);

        // === signal ===
        const s = data?.signal;
        const sb = document.getElementById("signal-box");
        if(s && !s.error){
          sb.innerHTML = `
            <div class="signal-row">
              <span class="chip mono">${s.pair || "‚Äî"}</span>
              <span class="chip ${dirClass(s.direction)} mono"><b>${(s.direction||"‚Äî").toUpperCase()}</b></span>
              <span class="chip mono">üéØ ${s.confidence ?? "‚Äî"}/10</span>
              <span class="chip mono">‚è± ${s.expiry_minutes ?? s.expiry ?? "‚Äî"} –º–∏–Ω</span>
              <span class="chip mono">üß† ${s.source || "‚Äî"}</span>
            </div>
            <div class="muted" style="margin-top:8px">
              –¶–µ–Ω–∞ –≤—Ö–æ–¥–∞: <b class="mono">${fmt(s.entry_price)}</b>
            </div>
          `;
        } else {
          sb.textContent = "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞";
        }

        // === chart (base64) ===
        const img = document.getElementById("chart");
        if(data?.chart_base64){
          img.src = data.chart_base64; // —É–∂–µ "data:image/png;base64,..."
          img.style.display = "block";
        } else {
          img.removeAttribute("src");
          img.style.display = "none";
        }

        // === last result ===
        const r = data?.result;
        const rb = document.getElementById("result-box");
        if(r && !r.error){
          rb.innerHTML = `
            <div class="signal-row">
              <span class="chip mono">${r.pair || "‚Äî"}</span>
              <span class="chip ${dirClass(r.direction)} mono">${(r.direction||"‚Äî").toUpperCase()}</span>
              <span class="chip mono">${(r.result||"‚Äî").toUpperCase()}</span>
            </div>
            <div class="muted" style="margin-top:8px">
              –í—Ö–æ–¥: <b class="mono">${fmt(r.entry_price)}</b>
              &nbsp;‚Üí&nbsp;
              –í—ã—Ö–æ–¥: <b class="mono">${fmt(r.exit_price)}</b>
            </div>
            <div class="muted" style="margin-top:6px">
              –ó–∞–≤–µ—Ä—à–µ–Ω–æ: <span class="mono">${(r.completed_at||r.timestamp||"").replace("T"," ").slice(0,19)}</span>
            </div>
          `;
        } else {
          rb.textContent = "–ù–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫";
        }

      } catch(e){
        console.error("FULL API error:", e);
        setStatus(false);
      }
    }

    async function loadHistory(){
      try{
        const res = await fetch(HIST_URL + "?t=" + Date.now());
        if(!res.ok) throw new Error("no history endpoint");
        const hist = await res.json(); // –æ–∂–∏–¥–∞–µ–º –º–∞—Å—Å–∏–≤
        const rows = Array.isArray(hist) ? hist.slice(-10).reverse() : [];
        const tb = document.getElementById("hist-body");
        if(!rows.length){
          tb.innerHTML = `<tr><td colspan="7" class="muted">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏</td></tr>`;
          return;
        }
        tb.innerHTML = rows.map((t, i)=>`
          <tr>
            <td class="mono">${i+1}</td>
            <td class="mono">${t.pair||"‚Äî"}</td>
            <td class="mono ${dirClass(t.direction)}">${(t.direction||"‚Äî").toUpperCase()}</td>
            <td class="mono">${(t.result||"‚Äî").toUpperCase()}</td>
            <td class="mono">${fmt(t.entry_price)}</td>
            <td class="mono">${fmt(t.exit_price)}</td>
            <td class="mono">${(t.completed_at||t.timestamp||"").replace("T"," ").slice(0,19)}</td>
          </tr>
        `).join("");
      }catch(e){
        // –ò—Å—Ç–æ—Ä–∏–∏ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—á–µ—Ä–∫
        const tb = document.getElementById("hist-body");
        tb.innerHTML = `<tr><td colspan="7" class="muted">‚Äî</td></tr>`;
      }
    }

    function tick(){
      loadFull();
      loadHistory();
    }
    // —Å—Ç–∞—Ä—Ç –∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    tick();
    setInterval(tick, REFRESH_MS);
  </script>
</body>
</html>
