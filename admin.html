<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aspire Trade - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --darker: #111827;
            --light: #f3f4f6;
            --gray: #6b7280;
            --bg: #0b0f19;
            --card1: rgba(20,26,48,.72);
            --card2: rgba(15,19,34,.86);
            --muted: #8d95af;
            --text: #e9ecf5;
            --good: #27e0a1;
            --bad: #ff5c7a;
            --accent: #5aa6ff;
            --accent2: #7b5bff;
            --border: rgba(255,255,255,.06);
            --shadow: 0 10px 30px rgba(0,0,0,.35);
            --radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: 
                radial-gradient(1200px 600px at 50% -10%, rgba(90,166,255,.08), transparent 60%),
                var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, var(--card1), var(--card2));
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: var(--shadow);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
        }

        .status-online {
            color: var(--secondary);
        }

        .status-offline {
            color: var(--danger);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .online-dot {
            background: var(--secondary);
        }

        .offline-dot {
            background: var(--danger);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .admin-badge {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--gray), #4b5563);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--secondary), #059669);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            padding: 12px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        /* Cards */
        .card {
            background: linear-gradient(180deg, var(--card1), var(--card2));
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .card h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 i {
            color: var(--primary);
        }

        /* Signal Card */
        .signal-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .signal-compact {
            text-align: center;
        }

        .signal-pair {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .signal-direction {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .signal-buy {
            color: var(--good);
        }

        .signal-sell {
            color: var(--bad);
        }

        .signal-hold {
            color: var(--warning);
        }

        .signal-details-compact {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .signal-detail-compact {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1rem;
            font-weight: bold;
            color: var(--text);
        }

        /* Chart Container */
        .chart-wrap {
            width: 100%;
            max-width: 760px;
            aspect-ratio: 16/10;
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg);
            border: 1px solid var(--border);
            position: relative;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
            margin: 0 auto 20px;
        }

        .chart {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
        }

        .chart--hidden {
            display: none;
        }

        /* Timer */
        .timerBox {
            width: 100%;
            max-width: 760px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            margin: 20px auto;
        }

        .timerText {
            font-variant-numeric: tabular-nums;
            font-size: 18px;
            font-weight: 800;
            letter-spacing: .5px;
        }

        .bar {
            width: 100%;
            height: 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,.05);
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
        }

        .bar__fill {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 100%;
            background: linear-gradient(90deg, var(--accent2), var(--accent));
            box-shadow: 0 0 12px rgba(123,91,255,.35);
            transition: width .25s linear;
        }

        /* Deal Card */
        .deal {
            width: 100%;
            max-width: 760px;
            background: linear-gradient(180deg, rgba(25,13,20,.75), rgba(20,12,18,.92));
            border: 1px solid rgba(255,92,122,.35);
            border-radius: 14px;
            padding: 16px;
            display: none;
            animation: .35s ease fadeIn;
            box-shadow: 0 10px 30px rgba(255,92,122,.18);
            margin: 20px auto;
        }

        .deal.win {
            background: linear-gradient(180deg, rgba(17,33,28,.75), rgba(14,26,23,.92));
            border: 1px solid rgba(39,224,161,.35);
            box-shadow: 0 10px 30px rgba(39,224,161,.18);
        }

        .deal .h {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 900;
            letter-spacing: .4px;
        }

        .deal .h .dot {
            width: 10px;
            height: 10px;
            background: var(--bad);
            border-radius: 50%;
        }

        .deal.win .h .dot {
            background: var(--good);
        }

        .rows {
            margin-top: 10px;
            display: grid;
            gap: 8px;
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .r {
            background: rgba(255,255,255,.02);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 12px;
        }

        .r .label {
            font-size: 12px;
            color: var(--muted);
        }

        .r .val {
            font-weight: 800;
            font-size: 16px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: none; }
        }

        .fade-in {
            animation: .3s ease fadeIn;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--muted);
            text-transform: uppercase;
        }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            height: 300px;
            position: relative;
        }

        .chart-card {
            grid-column: 1 / -1;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* User Management */
        .users-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            transition: background 0.3s ease;
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .user-details h4 {
            margin-bottom: 5px;
        }

        .user-details p {
            font-size: 0.8rem;
            color: var(--muted);
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        /* ML Management */
        .ml-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .ml-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .ml-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        /* System Controls */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .control-group h3 {
            margin-bottom: 15px;
            color: var(--text);
        }

        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Functions Grid */
        .functions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .function-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
        }

        .function-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .function-icon {
            font-size: 24px;
            margin-bottom: 12px;
            color: var(--primary);
        }

        .function-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }

        .function-desc {
            font-size: 12px;
            color: var(--muted);
        }

        /* Win Rate Bars */
        .winrate-container {
            margin: 20px 0;
        }

        .winrate-item {
            margin-bottom: 15px;
        }

        .winrate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .winrate-pair {
            font-weight: 600;
            color: var(--text);
        }

        .winrate-percentage {
            font-weight: 600;
            color: var(--good);
        }

        .winrate-bar-container {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .winrate-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .winrate-bar-win {
            background: linear-gradient(90deg, var(--good), #20c997);
        }

        .winrate-bar-loss {
            background: linear-gradient(90deg, var(--bad), #ff6b6b);
        }

        .winrate-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
        }

        /* Search */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 45px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: rgba(255, 255, 255, 0.05);
            color: var(--muted);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }

        td {
            color: var(--text);
            font-size: 14px;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .status-active {
            color: var(--secondary);
            font-weight: 600;
        }

        .status-inactive {
            color: var(--danger);
            font-weight: 600;
        }

        .status-blocked {
            color: var(--warning);
            font-weight: 600;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--secondary);
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.warning {
            background: var(--warning);
        }

        /* Loading and Error States */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--muted);
            text-align: center;
        }

        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-left: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--dark);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--border);
        }

        .modal h3 {
            margin-bottom: 20px;
            color: var(--text);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--muted);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .header-left, .header-right {
                justify-content: center;
            }
            
            .tabs {
                justify-content: center;
            }
            
            .signal-details-compact,
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Notification System -->
    <div id="notification" class="notification"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div id="statusIndicator" class="status-indicator status-offline">
                    <div class="status-dot offline-dot"></div>
                    <span>Bot Offline</span>
                </div>
                <div class="admin-badge">
                    <i class="fas fa-crown"></i> SUPER ADMIN
                </div>
            </div>
            <div class="header-right">
                <button class="btn" onclick="loadAllData()">
                    <i class="fas fa-sync-alt"></i> Обновить
                </button>
                <button class="btn btn-secondary" onclick="switchToUserView()">
                    <i class="fas fa-eye"></i> Вид пользователя
                </button>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Выйти
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('overview')">
                <i class="fas fa-tachometer-alt"></i> Обзор
            </div>
            <div class="tab" onclick="switchTab('users')">
                <i class="fas fa-users"></i> Пользователи
            </div>
            <div class="tab" onclick="switchTab('signals')">
                <i class="fas fa-chart-line"></i> Сигналы
            </div>
            <div class="tab" onclick="switchTab('analytics')">
                <i class="fas fa-chart-bar"></i> Аналитика
            </div>
            <div class="tab" onclick="switchTab('ml')">
                <i class="fas fa-brain"></i> ML Модель
            </div>
            <div class="tab" onclick="switchTab('system')">
                <i class="fas fa-cog"></i> Система
            </div>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <!-- Статистика -->
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-item">
                    <div class="stat-value" id="stat-users">—</div>
                    <div class="stat-label">Активных пользователей</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-accuracy">—%</div>
                    <div class="stat-label">Точность бота</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-trades">—</div>
                    <div class="stat-label">Всего сделок</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-status">—</div>
                    <div class="stat-label">Статус системы</div>
                </div>
            </div>

            <div class="dashboard">
                <!-- Signal Card с графиком и таймером -->
                <div class="card signal-card">
                    <h2><i class="fas fa-satellite-dish"></i> Live Signal</h2>
                    
                    <!-- График -->
                    <div class="chart-wrap">
                        <img id="chartImg" class="chart" alt="chart">
                    </div>

                    <!-- Информация о сигнале -->
                    <div class="signal-details-compact">
                        <div class="signal-detail-compact">
                            <div class="detail-label">Пара</div>
                            <div id="pair" class="detail-value">—</div>
                        </div>
                        <div class="signal-detail-compact">
                            <div class="detail-label">Направление</div>
                            <div id="direction" class="detail-value">—</div>
                        </div>
                        <div class="signal-detail-compact">
                            <div class="detail-label">Вход</div>
                            <div id="entry" class="detail-value">—</div>
                        </div>
                        <div class="signal-detail-compact">
                            <div class="detail-label">Экспирация</div>
                            <div id="expiry" class="detail-value">—</div>
                        </div>
                    </div>

                    <!-- Таймер обратного отсчета -->
                    <div class="timerBox">
                        <div id="timerText" class="timerText">⏳ —:—</div>
                        <div class="bar"><div id="barFill" class="bar__fill" style="width:100%"></div></div>
                    </div>

                    <!-- Карточка завершенной сделки -->
                    <div id="dealCard" class="deal">
                        <div class="h"><span class="dot"></span><span id="dealTitle">СДЕЛКА ЗАВЕРШЕНА</span></div>
                        <div class="rows">
                            <div class="r"><div class="label">Пара</div><div id="d_pair" class="val">—</div></div>
                            <div class="r"><div class="label">Направление</div><div id="d_dir" class="val">—</div></div>
                            <div class="r"><div class="label">Вход</div><div id="d_entry" class="val">—</div></div>
                            <div class="r"><div class="label">Выход</div><div id="d_exit" class="val">—</div></div>
                            <div class="r" style="grid-column:1/-1"><div class="label">Результат</div><div id="d_res" class="val">—</div></div>
                        </div>
                    </div>
                </div>

                <!-- Functions Grid -->
                <div class="card">
                    <h2><i class="fas fa-cogs"></i> Быстрые действия</h2>
                    <div class="functions-grid">
                        <div class="function-card" onclick="switchTab('users')">
                            <div class="function-icon">
                                <i class="fas fa-users-cog"></i>
                            </div>
                            <div class="function-title">Управление пользователями</div>
                            <div class="function-desc">Просмотр, активация, блокировка пользователей</div>
                        </div>
                        
                        <div class="function-card" onclick="sendAdminCommand('retrain', 'Запуск переобучения ML модели...')">
                            <div class="function-icon">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div class="function-title">Обучение ML модели</div>
                            <div class="function-desc">Переобучение нейросети на новых данных</div>
                        </div>
                        
                        <div class="function-card" onclick="switchTab('analytics')">
                            <div class="function-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div class="function-title">Детальная аналитика</div>
                            <div class="function-desc">Статистика по парам и эффективности</div>
                        </div>
                        
                        <div class="function-card" onclick="switchTab('system')">
                            <div class="function-icon">
                                <i class="fas fa-server"></i>
                            </div>
                            <div class="function-title">Системные метрики</div>
                            <div class="function-desc">Мониторинг производительности системы</div>
                        </div>
                        
                        <div class="function-card" onclick="sendAdminCommand('broadcast', 'Форма рассылки...')">
                            <div class="function-icon">
                                <i class="fas fa-bullhorn"></i>
                            </div>
                            <div class="function-title">Рассылка сообщений</div>
                            <div class="function-desc">Отправка уведомлений всем пользователям</div>
                        </div>
                        
                        <div class="function-card" onclick="sendAdminCommand('backup', 'Создание резервной копии...')">
                            <div class="function-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="function-title">Резервное копирование</div>
                            <div class="function-desc">Создание бэкапа базы данных</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-users"></i> Управление пользователями</h2>
                
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Поиск по ID пользователя (например: 5489888474)" oninput="searchUsers(this.value)">
                </div>

                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="showAddUserModal()">
                        <i class="fas fa-plus"></i> Добавить пользователя
                    </button>
                    <button class="btn btn-danger" onclick="bulkRemoveUsers()">
                        <i class="fas fa-ban"></i> Удалить выбранных
                    </button>
                    <button class="btn btn-warning" onclick="bulkBlockUsers()">
                        <i class="fas fa-lock"></i> Заблокировать выбранных
                    </button>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-users" onchange="toggleSelectAllUsers(this.checked)"></th>
                                <th>ID</th>
                                <th>Имя</th>
                                <th>Telegram ID</th>
                                <th>Регистрация</th>
                                <th>Активность</th>
                                <th>Точность</div>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr>
                                <td colspan="9" class="loading">
                                    <div class="loading-spinner"></div>
                                    <p>Загрузка пользователей...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Signals Tab -->
        <div id="signals-tab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-chart-line"></i> Активные сигналы</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div></div>
                    <button class="btn btn-danger" onclick="sendAdminCommand('clearalltrades', 'Закрытие всех сделок...')">
                        <i class="fas fa-times"></i> Закрыть все сделки
                    </button>
                </div>
                <div id="adminSignalsContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Загрузка активных сигналов...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-chart-bar"></i> Эффективность по парам</h2>
                <div class="winrate-container" id="pairsWinrateContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Загрузка статистики по парам...</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-brain"></i> Статистика ML модели</h2>
                <div class="chart-container">
                    <canvas id="mlAnalyticsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ML Tab -->
        <div id="ml-tab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-brain"></i> Управление ML Моделью</h2>
                
                <div class="ml-info">
                    <h3>Текущее состояние модели</h3>
                    <div class="ml-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="ml-accuracy">—%</div>
                            <div class="stat-label">Текущая точность</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="ml-trades">—</div>
                            <div class="stat-label">Обучение на сделках</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="ml-version">v3.2.1</div>
                            <div class="stat-label">Версия модели</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="ml-status">—</div>
                            <div class="stat-label">Статус</div>
                        </div>
                    </div>
                </div>

                <div class="ml-controls">
                    <div class="function-card" onclick="executeMLCommand('retrain')">
                        <div class="function-icon">
                            <i class="fas fa-retweet"></i>
                        </div>
                        <div class="function-title">Переобучить модель</div>
                        <div class="function-desc">Обучение на новых данных</div>
                    </div>
                    
                    <div class="function-card" onclick="executeMLCommand('forceml')">
                        <div class="function-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="function-title">Принудительно включить ML</div>
                        <div class="function-desc">Активация ML функций</div>
                    </div>
                    
                    <div class="function-card" onclick="executeMLCommand('repairml')">
                        <div class="function-icon">
                            <i class="fas fa-tools"></i>
                        </div>
                        <div class="function-title">Восстановить ML</div>
                        <div class="function-desc">Ремонт ML фичей</div>
                    </div>

                    <div class="function-card" onclick="executeMLCommand('optimize')">
                        <div class="function-icon">
                            <i class="fas fa-rocket"></i>
                        </div>
                        <div class="function-title">Оптимизировать модель</div>
                        <div class="function-desc">Улучшение параметров</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Tab -->
        <div id="system-tab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-cog"></i> Системные команды</h2>
                
                <div class="controls-grid">
                    <div class="control-group">
                        <h3>Основные операции</h3>
                        <div class="control-buttons">
                            <button class="btn btn-danger" onclick="sendAdminCommand('stop', 'Остановка бота...')">
                                <i class="fas fa-power-off"></i> Остановить бота
                            </button>
                            <button class="btn btn-warning" onclick="sendAdminCommand('restart', 'Перезапуск бота...')">
                                <i class="fas fa-redo"></i> Перезапустить бота
                            </button>
                            <button class="btn" onclick="sendAdminCommand('checkdata', 'Проверка данных...')">
                                <i class="fas fa-check-circle"></i> Проверить данные
                            </button>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Управление данными</h3>
                        <div class="control-buttons">
                            <button class="btn btn-danger" onclick="sendAdminCommand('clearalltrades', 'Очистка всех сделок...')">
                                <i class="fas fa-trash"></i> Очистить все сделки
                            </button>
                            <button class="btn btn-warning" onclick="sendAdminCommand('restorecounter', 'Восстановление счетчиков...')">
                                <i class="fas fa-undo"></i> Восстановить счетчики
                            </button>
                            <button class="btn" onclick="sendAdminCommand('cleartrade', 'Очистка активной сделки...')">
                                <i class="fas fa-times"></i> Очистить активную сделку
                            </button>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Резервное копирование</h3>
                        <div class="control-buttons">
                            <button class="btn btn-success" onclick="sendAdminCommand('backup', 'Создание резервной копии...')">
                                <i class="fas fa-database"></i> Создать бэкап
                            </button>
                            <button class="btn" onclick="sendAdminCommand('restorebackup', 'Восстановление из бэкапа...')">
                                <i class="fas fa-history"></i> Восстановить из бэкапа
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-user-plus"></i> Добавить пользователя</h3>
            <div class="form-group">
                <label for="userPocketId">Pocket Option ID:</label>
                <input type="text" id="userPocketId" placeholder="Введите Pocket ID">
            </div>
            <div class="form-group">
                <label for="userName">Имя пользователя:</label>
                <input type="text" id="userName" placeholder="Введите имя">
            </div>
            <div class="form-group">
                <label for="userTelegramId">Telegram ID (опционально):</label>
                <input type="text" id="userTelegramId" placeholder="Введите Telegram ID">
            </div>
            <div class="form-group">
                <label for="userRole">Роль:</label>
                <select id="userRole">
                    <option value="user">Пользователь</option>
                    <option value="admin">Администратор</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Отмена</button>
                <button class="btn btn-success" onclick="addUser()">Добавить</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-user-edit"></i> Редактировать пользователя</h3>
            <input type="hidden" id="editUserId">
            <div class="form-group">
                <label for="editUserName">Имя пользователя:</label>
                <input type="text" id="editUserName" placeholder="Введите имя">
            </div>
            <div class="form-group">
                <label for="editUserTelegramId">Telegram ID:</label>
                <input type="text" id="editUserTelegramId" placeholder="Введите Telegram ID">
            </div>
            <div class="form-group">
                <label for="editUserStatus">Статус:</label>
                <select id="editUserStatus">
                    <option value="active">Активен</option>
                    <option value="inactive">Неактивен</option>
                    <option value="blocked">Заблокирован</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEditModal()">Отмена</button>
                <button class="btn btn-success" onclick="updateUser()">Сохранить</button>
            </div>
        </div>
    </div>

    <script>
        // Конфигурация
        const BASE_URL = 'https://nonurban-joella-unvagrantly.ngrok-free.dev';
        let appState = {
            isOnline: false,
            charts: {},
            currentTab: 'overview',
            users: [],
            lastSignalTs: 0,
            lastTradeIdShown: null,
            timerInt: null,
            totalMs: 0,
            expiryMs: 0,
            selectedUsers: new Set()
        };

        // Уведомления
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Навигация по вкладкам
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            appState.currentTab = tabName;
            
            switch(tabName) {
                case 'users':
                    loadUsersTable();
                    break;
                case 'signals':
                    loadAdminSignals();
                    break;
                case 'analytics':
                    loadAnalyticsCharts();
                    break;
                case 'ml':
                    loadMLData();
                    break;
            }
        }

        // Функции для графика и таймера
        const pad = x => String(x).padStart(2,'0');
        const fmt = n => (n===null||n===undefined) ? "—" : (typeof n==="number" ? (Math.abs(n) >= 1 ? n.toFixed(5) : n.toPrecision(6)) : n);

        function setChartVisible(v){
            const img = document.getElementById('chartImg');
            if(v) img.classList.remove('chart--hidden'); 
            else img.classList.add('chart--hidden');
        }

        function setDealVisible(v, isWin=false){
            const card = document.getElementById('dealCard');
            if(v){
                card.style.display = 'block';
                card.classList.add('fade-in');
                isWin ? card.classList.add('win') : card.classList.remove('win');
            }else{
                card.style.display = 'none';
                card.classList.remove('win');
            }
        }

        function startTimer(createdTs, expiryMinutes){
            clearInterval(appState.timerInt);

            if(!createdTs || !expiryMinutes){
                document.getElementById('timerText').textContent = '⏳ —:—';
                document.getElementById('barFill').style.width = '0%';
                return;
            }

            const createdMs = (typeof createdTs === 'number') ? createdTs : new Date(createdTs).getTime();
            const expiryMs  = createdMs + (expiryMinutes * 60 * 1000);
            const totalMs   = Math.max(1, expiryMs - createdMs);

            appState.expiryMs = expiryMs;
            appState.totalMs  = totalMs;

            const tick = () => {
                const now = Date.now();
                const rem = Math.max(0, expiryMs - now);
                const mm = Math.floor(rem/1000/60);
                const ss = Math.floor(rem/1000) % 60;
                document.getElementById('timerText').textContent = `⏳ Осталось: ${pad(mm)}:${pad(ss)}`;

                const pct = Math.max(0, Math.min(100, (rem / totalMs) * 100));
                document.getElementById('barFill').style.width = `${pct}%`;

                if(rem<=0){
                    clearInterval(appState.timerInt);
                }
            };

            tick();
            appState.timerInt = setInterval(tick, 250);
        }

        // Рендер сигнала
        function renderSignal(sig, chartBase64){
            setDealVisible(false);
            setChartVisible(true);

            document.getElementById('pair').textContent = sig?.pair ?? '—';

            const dir = String(sig?.direction||'—').toUpperCase();
            const dirEl = document.getElementById('direction');
            dirEl.textContent = dir;
            dirEl.className = 'detail-value';
            if(dir==='BUY') dirEl.classList.add('signal-buy');
            if(dir==='SELL') dirEl.classList.add('signal-sell');

            document.getElementById('entry').textContent = fmt(sig?.entry_price ?? sig?.entry);

            const createdTs = sig?.timestamp ?? sig?.created_at ?? Date.now();
            const expMin    = sig?.expiry ?? sig?.expiry_minutes ?? null;
            if(createdTs && expMin){
                const expAt = new Date((typeof createdTs==='number'?createdTs:new Date(createdTs).getTime()) + expMin*60*1000);
                document.getElementById('expiry').textContent = expAt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                startTimer(createdTs, expMin);
            }else{
                document.getElementById('expiry').textContent = '—';
                startTimer(null, null);
            }

            if(chartBase64){
                document.getElementById('chartImg').src = chartBase64.startsWith("data:image") 
                    ? chartBase64 
                    : `data:image/png;base64,${chartBase64}`;
            }
        }

        function renderCompleted(res){
            const id   = res?.trade_id ?? '—';
            const pair = res?.pair ?? '—';
            const dir  = res?.direction ? String(res.direction).toUpperCase() : '—';
            const entry= res?.entry_price ?? res?.entry ?? '—';
            const exit = res?.exit_price  ?? res?.exit  ?? '—';
            const result = (res?.result || '—').toUpperCase();

            const prefix = (result==='WIN') ? '🟢 СДЕЛКА #' : '🔴 СДЕЛКА #';
            document.getElementById('dealTitle').textContent = `${prefix}${id} ЗАВЕРШЕНА`;

            document.getElementById('d_pair').textContent  = pair;
            document.getElementById('d_dir').textContent   = dir;
            document.getElementById('d_entry').textContent = fmt(entry);
            document.getElementById('d_exit').textContent  = fmt(exit);
            document.getElementById('d_res').textContent   = result;

            setChartVisible(false);
            setDealVisible(true, result==='WIN');

            clearInterval(appState.timerInt);
            document.getElementById('timerText').textContent = '⏳ —:—';
            document.getElementById('barFill').style.width = '0%';
        }

        // Загрузка всех данных
        async function loadAllData() {
            try {
                console.log('Загрузка данных с:', BASE_URL);
                
                const [systemData, signalData, usersData] = await Promise.allSettled([
                    fetch(`${BASE_URL}/api/system_status.json`, {cache: 'no-store'}).then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    }),
                    fetch(`${BASE_URL}/api/latest_full.json`, {cache: 'no-store'}).then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    }),
                    fetch(`${BASE_URL}/pocket_users.json`, {cache: 'no-store'}).then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    })
                ]);

                console.log('Полученные данные:', { systemData, signalData, usersData });

                // Обновляем статус системы
                if (systemData.status === 'fulfilled') {
                    await handleSystemData(systemData.value);
                } else {
                    console.error('Ошибка system_data:', systemData.reason);
                }

                // Обновляем сигналы и графики
                if (signalData.status === 'fulfilled') {
                    await handleSignalData(signalData.value);
                } else {
                    console.error('Ошибка signal_data:', signalData.reason);
                }

                // Обновляем данные пользователей
                if (usersData.status === 'fulfilled') {
                    await handleUsersData(usersData.value);
                } else {
                    console.error('Ошибка users_data:', usersData.reason);
                    // Пробуем альтернативный путь
                    try {
                        const altUsers = await fetch(`${BASE_URL}/api/pocket_users.json`, {cache: 'no-store'}).then(r => r.json());
                        await handleUsersData(altUsers);
                    } catch (e) {
                        console.error('Альтернативный путь тоже не сработал:', e);
                    }
                }

                appState.isOnline = true;
                updateStatusIndicator(true);

            } catch (error) {
                console.error('Общая ошибка загрузки:', error);
                handleError('Ошибка соединения с сервером');
                appState.isOnline = false;
                updateStatusIndicator(false);
            }
        }

        // Обработка данных системы
        async function handleSystemData(data) {
            console.log('Данные системы:', data);
            
            // Обновляем статистику
            const totalUsers = data.total_users || data.active_users || 0;
            const winRate = data.win_rate || data.accuracy || 0;
            const totalTrades = data.total_trades || 0;
            const botStatus = data.bot_status || data.status || 'unknown';

            document.getElementById('stat-users').textContent = totalUsers;
            document.getElementById('stat-accuracy').textContent = `${winRate}%`;
            document.getElementById('stat-trades').textContent = totalTrades;
            
            // Определяем статус системы
            let statusText = 'Неизвестно';
            
            if (botStatus === 'running' || botStatus === 'active') {
                statusText = 'Работает';
            } else if (botStatus === 'stopped' || botStatus === 'inactive') {
                statusText = 'Остановлен';
            } else {
                // Проверяем наличие активных пользователей как индикатор работы
                if (totalUsers > 0) {
                    statusText = 'Работает';
                } else {
                    statusText = 'Нет активных';
                }
            }
            
            document.getElementById('stat-status').textContent = statusText;
        }

        // Обработка данных сигналов
        async function handleSignalData(data) {
            console.log('Данные сигналов:', data);
            
            const sig = data?.signal || null;
            const res = data?.result || null;
            const chartB64 = data?.chart_base64 || null;

            let showSignal = false;
            if(sig && sig.pair){
                const created = sig?.timestamp ?? sig?.created_at ?? null;
                const expMin  = sig?.expiry ?? sig?.expiry_minutes ?? null;
                if(created && expMin){
                    const createdMs = (typeof created==='number') ? created : new Date(created).getTime();
                    const expMs = createdMs + expMin*60*1000;
                    showSignal = expMs > Date.now();
                } else {
                    // Если нет времени экспирации, но есть сигнал - показываем его
                    showSignal = true;
                }
            }

            if(showSignal){
                const stamp = sig?.timestamp ? (typeof sig.timestamp==='number' ? sig.timestamp : new Date(sig.timestamp).getTime())
                                             : (sig?.created_at ? new Date(sig.created_at).getTime() : Date.now());
                if (stamp !== appState.lastSignalTs){
                    appState.lastSignalTs = stamp;
                    renderSignal(sig, chartB64);
                }
            }else if(res && res.trade_id){
                if(res.trade_id !== appState.lastTradeIdShown){
                    appState.lastTradeIdShown = res.trade_id;
                    renderCompleted(res);
                }
            } else {
                // Нет активного сигнала и нет завершенной сделки
                setDealVisible(false);
                setChartVisible(false);
                clearInterval(appState.timerInt);
                document.getElementById('timerText').textContent = '⏳ Ожидание сигнала';
                document.getElementById('barFill').style.width = '0%';
            }
        }

        // Обработка данных пользователей
        async function handleUsersData(data) {
            console.log('Данные пользователей:', data);
            
            if (!data) {
                console.log('Нет данных пользователей');
                return;
            }

            // Обрабатываем разные форматы данных
            let users = [];
            
            if (Array.isArray(data)) {
                users = data;
            } else if (data.users && Array.isArray(data.users)) {
                users = data.users;
            } else if (typeof data === 'object') {
                // Формат { "user_id": { user_data }, ... }
                users = Object.entries(data).map(([id, userData]) => ({
                    id: id,
                    ...userData
                }));
            }

            appState.users = users;
            
            // Обновляем статистику пользователей
            const activeUsers = users.filter(user => 
                user.status === 'active' || user.is_active || user.last_activity
            ).length;

            // Обновляем счетчик пользователей в статистике
            document.getElementById('stat-users').textContent = activeUsers || users.length;
            
            // Если на вкладке пользователей - обновляем таблицу
            if (appState.currentTab === 'users') {
                renderUsersTable();
            }
        }

        // Обновление интерфейса
        function updateStatusIndicator(isOnline) {
            const indicator = document.getElementById('statusIndicator');
            if (isOnline) {
                indicator.className = 'status-indicator status-online';
                indicator.innerHTML = '<div class="status-dot online-dot"></div><span>Bot Online</span>';
            } else {
                indicator.className = 'status-indicator status-offline';
                indicator.innerHTML = '<div class="status-dot offline-dot"></div><span>Bot Offline</span>';
            }
        }

        // Управление пользователями
        async function loadUsersTable() {
            try {
                // Если пользователи уже загружены, используем их
                if (appState.users.length > 0) {
                    renderUsersTable();
                    return;
                }

                // Иначе загружаем заново
                const response = await fetch(`${BASE_URL}/pocket_users.json`, {cache: 'no-store'});
                if (!response.ok) throw new Error('Failed to load users');
                
                const data = await response.json();
                await handleUsersData(data);

            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTable').innerHTML = `
                    <tr>
                        <td colspan="9" class="error">
                            <p>Ошибка загрузки пользователей: ${error.message}</p>
                            <button class="btn btn-secondary" onclick="loadUsersTable()" style="margin-top: 10px;">
                                Попробовать снова
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        function renderUsersTable() {
            const container = document.getElementById('usersTable');
            
            if (!appState.users || appState.users.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="9" class="loading">
                            <i class="fas fa-users"></i>
                            <p>Пользователи не найдены</p>
                        </td>
                    </tr>
                `;
                return;
            }

            let usersHTML = '';
            
            appState.users.forEach(user => {
                const isActive = user.status === 'active';
                const isBlocked = user.status === 'blocked';
                const statusClass = isBlocked ? 'status-blocked' : (isActive ? 'status-active' : 'status-inactive');
                const statusText = isBlocked ? 'Заблокирован' : (isActive ? 'Активен' : 'Неактивен');
                
                const lastActivity = user.last_activity ? 
                    new Date(user.last_activity).toLocaleDateString('ru-RU') : 
                    'Неизвестно';
                
                usersHTML += `
                    <tr>
                        <td><input type="checkbox" data-user-id="${user.id}" onchange="toggleUserSelection('${user.id}', this.checked)"></td>
                        <td>${user.id || '—'}</td>
                        <td>${user.name || user.username || '—'}</td>
                        <td>${user.telegram_id || user.tg_id || '—'}</td>
                        <td>${user.registered_at ? new Date(user.registered_at).toLocaleDateString('ru-RU') : '—'}</td>
                        <td>${lastActivity}</td>
                        <td>${user.accuracy || user.win_rate || 0}%</td>
                        <td class="${statusClass}">${statusText}</td>
                        <td>
                            <button class="btn btn-small" onclick="editUser('${user.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteUser('${user.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn btn-small btn-warning" onclick="toggleUserStatus('${user.id}')">
                                <i class="fas ${isBlocked ? 'fa-unlock' : 'fa-lock'}"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            container.innerHTML = usersHTML;
        }

        // Управление выделением пользователей
        function toggleSelectAllUsers(checked) {
            const checkboxes = document.querySelectorAll('#usersTable input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = checked;
                const userId = checkbox.getAttribute('data-user-id');
                if (checked) {
                    appState.selectedUsers.add(userId);
                } else {
                    appState.selectedUsers.delete(userId);
                }
            });
        }

        function toggleUserSelection(userId, checked) {
            if (checked) {
                appState.selectedUsers.add(userId);
            } else {
                appState.selectedUsers.delete(userId);
            }
            
            // Обновляем состояние главного чекбокса
            const allCheckboxes = document.querySelectorAll('#usersTable input[type="checkbox"]');
            const selectAllCheckbox = document.getElementById('select-all-users');
            const checkedCount = Array.from(allCheckboxes).filter(cb => cb.checked).length;
            selectAllCheckbox.checked = checkedCount === allCheckboxes.length;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
        }

        // Модальные окна пользователя
        function showAddUserModal() {
            document.getElementById('addUserModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('addUserModal').style.display = 'none';
        }

        function closeEditModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        async function addUser() {
            const pocketId = document.getElementById('userPocketId').value;
            const name = document.getElementById('userName').value;
            const telegramId = document.getElementById('userTelegramId').value;
            const role = document.getElementById('userRole').value;

            if (!pocketId || !name) {
                showNotification('Заполните все обязательные поля', 'error');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/admin/add_user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pocket_id: pocketId,
                        name: name,
                        telegram_id: telegramId,
                        role: role
                    })
                });

                if (response.ok) {
                    showNotification(`Пользователь ${name} успешно добавлен`, 'success');
                    closeModal();
                    loadUsersTable();
                    
                    // Очищаем форму
                    document.getElementById('userPocketId').value = '';
                    document.getElementById('userName').value = '';
                    document.getElementById('userTelegramId').value = '';
                } else {
                    throw new Error('Ошибка сервера');
                }
            } catch (error) {
                showNotification(`Ошибка добавления пользователя: ${error.message}`, 'error');
            }
        }

        function editUser(userId) {
            const user = appState.users.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('editUserId').value = userId;
            document.getElementById('editUserName').value = user.name || user.username || '';
            document.getElementById('editUserTelegramId').value = user.telegram_id || user.tg_id || '';
            document.getElementById('editUserStatus').value = user.status || 'active';
            
            document.getElementById('editUserModal').style.display = 'flex';
        }

        async function updateUser() {
            const userId = document.getElementById('editUserId').value;
            const name = document.getElementById('editUserName').value;
            const telegramId = document.getElementById('editUserTelegramId').value;
            const status = document.getElementById('editUserStatus').value;

            try {
                const response = await fetch(`${BASE_URL}/api/admin/update_user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        name: name,
                        telegram_id: telegramId,
                        status: status
                    })
                });

                if (response.ok) {
                    showNotification(`Пользователь ${name} успешно обновлен`, 'success');
                    closeEditModal();
                    loadUsersTable();
                } else {
                    throw new Error('Ошибка сервера');
                }
            } catch (error) {
                showNotification(`Ошибка обновления пользователя: ${error.message}`, 'error');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) return;

            try {
                const response = await fetch(`${BASE_URL}/api/admin/delete_user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: userId })
                });

                if (response.ok) {
                    showNotification('Пользователь успешно удален', 'success');
                    loadUsersTable();
                } else {
                    throw new Error('Ошибка сервера');
                }
            } catch (error) {
                showNotification(`Ошибка удаления пользователя: ${error.message}`, 'error');
            }
        }

        async function toggleUserStatus(userId) {
            const user = appState.users.find(u => u.id === userId);
            if (!user) return;

            const newStatus = user.status === 'blocked' ? 'active' : 'blocked';
            const action = newStatus === 'blocked' ? 'заблокировать' : 'разблокировать';

            if (!confirm(`Вы уверены, что хотите ${action} этого пользователя?`)) return;

            try {
                const response = await fetch(`${BASE_URL}/api/admin/update_user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        status: newStatus
                    })
                });

                if (response.ok) {
                    showNotification(`Пользователь успешно ${newStatus === 'blocked' ? 'заблокирован' : 'разблокирован'}`, 'success');
                    loadUsersTable();
                } else {
                    throw new Error('Ошибка сервера');
                }
            } catch (error) {
                showNotification(`Ошибка изменения статуса пользователя: ${error.message}`, 'error');
            }
        }

        function bulkRemoveUsers() {
            const selectedUsers = Array.from(appState.selectedUsers);
            
            if (selectedUsers.length === 0) {
                showNotification('Выберите пользователей для удаления', 'warning');
                return;
            }
            
            if (confirm(`Удалить ${selectedUsers.length} пользователей из системы?`)) {
                selectedUsers.forEach(userId => deleteUser(userId));
            }
        }

        function bulkBlockUsers() {
            const selectedUsers = Array.from(appState.selectedUsers);
            
            if (selectedUsers.length === 0) {
                showNotification('Выберите пользователей для блокировки', 'warning');
                return;
            }
            
            if (confirm(`Заблокировать ${selectedUsers.length} пользователей?`)) {
                selectedUsers.forEach(userId => {
                    const user = appState.users.find(u => u.id === userId);
                    if (user && user.status !== 'blocked') {
                        toggleUserStatus(userId);
                    }
                });
            }
        }

        // Аналитика - Win Rate по парам
        function loadAnalyticsCharts() {
            // Загружаем реальные данные по парам
            loadPairsWinrateData();
            
            // График ML аналитики
            const mlCtx = document.getElementById('mlAnalyticsChart').getContext('2d');
            if (appState.charts.mlAnalytics) {
                appState.charts.mlAnalytics.destroy();
            }
            
            appState.charts.mlAnalytics = new Chart(mlCtx, {
                type: 'line',
                data: {
                    labels: ['Янв 10', 'Янв 11', 'Янв 12', 'Янв 13', 'Янв 14', 'Янв 15'],
                    datasets: [{
                        label: 'Точность ML %',
                        data: [72.1, 74.3, 75.8, 76.2, 77.5, 78.3],
                        borderColor: 'rgba(16, 185, 129, 0.8)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#f3f4f6'
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            },
                            ticks: {
                                color: '#f3f4f6'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            },
                            ticks: {
                                color: '#f3f4f6'
                            }
                        }
                    }
                }
            });
        }

        function loadPairsWinrateData() {
            const container = document.getElementById('pairsWinrateContainer');
            
            // Демо-данные по парам (в реальности нужно загружать с сервера)
            const pairsData = [
                { pair: 'EURUSD', winRate: 76.6, totalTrades: 45, winTrades: 34, lossTrades: 11 },
                { pair: 'GBPUSD', winRate: 73.5, totalTrades: 34, winTrades: 25, lossTrades: 9 },
                { pair: 'USDJPY', winRate: 78.2, totalTrades: 55, winTrades: 43, lossTrades: 12 },
                { pair: 'AUDCHF', winRate: 71.1, totalTrades: 38, winTrades: 27, lossTrades: 11 },
                { pair: 'GBPCHF', winRate: 68.9, totalTrades: 29, winTrades: 20, lossTrades: 9 },
                { pair: 'EURCHF', winRate: 74.3, totalTrades: 41, winTrades: 30, lossTrades: 11 },
                { pair: 'USDCAD', winRate: 69.8, totalTrades: 33, winTrades: 23, lossTrades: 10 }
            ];

            let winrateHTML = '';
            
            pairsData.forEach(pairData => {
                const winPercentage = pairData.winRate;
                const lossPercentage = 100 - winPercentage;
                
                winrateHTML += `
                    <div class="winrate-item">
                        <div class="winrate-header">
                            <span class="winrate-pair">${pairData.pair}</span>
                            <span class="winrate-percentage">${winPercentage}%</span>
                        </div>
                        <div class="winrate-bar-container">
                            <div class="winrate-bar winrate-bar-win" style="width: ${winPercentage}%"></div>
                            <div class="winrate-bar winrate-bar-loss" style="width: ${lossPercentage}%"></div>
                        </div>
                        <div class="winrate-stats">
                            <span>Выигрыши: ${pairData.winTrades}</span>
                            <span>Проигрыши: ${pairData.lossTrades}</span>
                            <span>Всего: ${pairData.totalTrades}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = winrateHTML;
        }

        // ML команды
        async function executeMLCommand(command) {
            const commands = {
                'retrain': { message: 'Запуск переобучения ML модели...', endpoint: '/api/admin/retrain_ml' },
                'forceml': { message: 'Принудительное включение ML...', endpoint: '/api/admin/force_ml' },
                'repairml': { message: 'Восстановление ML...', endpoint: '/api/admin/repair_ml' },
                'optimize': { message: 'Оптимизация модели...', endpoint: '/api/admin/optimize_ml' }
            };

            const cmd = commands[command];
            if (!cmd) return;

            showNotification(cmd.message, 'warning');
            
            try {
                const response = await fetch(`${BASE_URL}${cmd.endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(`ML команда выполнена: ${result.message || 'Успешно'}`, 'success');
                    
                    // Обновляем данные ML
                    setTimeout(() => {
                        loadMLData();
                        loadAllData();
                    }, 2000);
                } else {
                    throw new Error('Ошибка сервера');
                }
            } catch (error) {
                showNotification(`Ошибка выполнения ML команды: ${error.message}`, 'error');
            }
        }

        // Загрузка ML данных
        async function loadMLData() {
            try {
                const response = await fetch(`${BASE_URL}/api/ml_status.json`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('ml-accuracy').textContent = `${data.accuracy || 78.3}%`;
                    document.getElementById('ml-trades').textContent = data.training_trades || '1,247';
                    document.getElementById('ml-status').textContent = data.status === 'active' ? 'Активна' : 'Неактивна';
                }
            } catch (error) {
                console.error('Ошибка загрузки ML данных:', error);
            }
        }

        // Сигналы
        async function loadAdminSignals() {
            const container = document.getElementById('adminSignalsContainer');
            
            try {
                const response = await fetch(`${BASE_URL}/api/last_signal.json`);
                const signal = await response.json();
                
                if (signal.error || !signal.pair) {
                    container.innerHTML = '<div class="error">Нет активных сигналов</div>';
                    return;
                }
                
                container.innerHTML = `
                    <div class="card signal-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>${signal.pair} - ${signal.direction}</h3>
                            <span class="status-active">Уверенность: ${signal.confidence}/10</span>
                        </div>
                        <div class="signal-details-compact">
                            <div class="signal-detail-compact">
                                <div class="detail-label">Пара</div>
                                <div class="detail-value">${signal.pair}</div>
                            </div>
                            <div class="signal-detail-compact">
                                <div class="detail-label">Направление</div>
                                <div class="detail-value" style="color: ${signal.direction === 'BUY' ? 'var(--good)' : 'var(--bad)'};">${signal.direction}</div>
                            </div>
                            <div class="signal-detail-compact">
                                <div class="detail-label">Цена входа</div>
                                <div class="detail-value">${signal.entry_price || '—'}</div>
                            </div>
                            <div class="signal-detail-compact">
                                <div class="detail-label">Экспирация</div>
                                <div class="detail-value">${signal.expiry || '—'} мин</div>
                            </div>
                        </div>
                        <button class="btn btn-danger" style="width: 100%; margin-top: 15px;" onclick="sendAdminCommand('cleartrade', 'Очистка активной сделки...')">
                            <i class="fas fa-times"></i> Принудительно закрыть сделку
                        </button>
                    </div>
                `;
                
            } catch (error) {
                container.innerHTML = `<div class="error">Ошибка загрузки сигналов: ${error.message}</div>`;
            }
        }

        // Команды админа
        async function sendAdminCommand(command, message) {
            showNotification(message, 'warning');
            
            try {
                const response = await fetch(`${BASE_URL}/api/admin/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: command })
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(`Команда "${command}" выполнена: ${result.message || 'Успешно'}`, 'success');
                    loadAllData();
                } else {
                    throw new Error('Ошибка сервера');
                }
            } catch (error) {
                showNotification(`Ошибка выполнения команды: ${error.message}`, 'error');
            }
        }

        // Вспомогательные функции
        function searchUsers(query) {
            if (query.length >= 3) {
                console.log(`Поиск пользователей: ${query}`);
                // Реализация поиска пользователей
            }
        }

        function switchToUserView() {
            window.open('/trading.html', '_blank');
        }

        function logout() {
            if (confirm('Вы уверены, что хотите выйти?')) {
                showNotification('Выход из системы...', 'info');
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 1000);
            }
        }

        function handleError(message) {
            showNotification(message, 'error');
            updateStatusIndicator(false);
        }

        // Инициализация
        function init() {
            loadAllData();
            setInterval(loadAllData, 5000); // Обновление каждые 5 секунд
            
            window.addEventListener('click', (e) => {
                if (e.target === document.getElementById('addUserModal')) {
                    closeModal();
                }
                if (e.target === document.getElementById('editUserModal')) {
                    closeEditModal();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
