<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aspire Trade - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --darker: #111827;
            --light: #f3f4f6;
            --gray: #6b7280;
            --bg: #0b0f19;
            --card1: rgba(20,26,48,.72);
            --card2: rgba(15,19,34,.86);
            --muted: #8d95af;
            --text: #e9ecf5;
            --good: #27e0a1;
            --bad: #ff5c7a;
            --accent: #5aa6ff;
            --accent2: #7b5bff;
            --border: rgba(255,255,255,.06);
            --shadow: 0 10px 30px rgba(0,0,0,.35);
            --radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: 
                radial-gradient(1200px 600px at 50% -10%, rgba(90,166,255,.08), transparent 60%),
                var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, var(--card1), var(--card2));
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: var(--shadow);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
        }

        .status-online {
            color: var(--secondary);
        }

        .status-offline {
            color: var(--danger);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .online-dot {
            background: var(--secondary);
        }

        .offline-dot {
            background: var(--danger);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .admin-badge {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--gray), #4b5563);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--secondary), #059669);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            padding: 12px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        /* Cards */
        .card {
            background: linear-gradient(180deg, var(--card1), var(--card2));
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .card h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 i {
            color: var(--primary);
        }

        /* Signal Card - Стили из trading.html */
        .signal-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .signal-compact {
            text-align: center;
        }

        .signal-pair {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .signal-direction {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .signal-buy {
            color: var(--good);
        }

        .signal-sell {
            color: var(--bad);
        }

        .signal-hold {
            color: var(--warning);
        }

        .signal-details-compact {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .signal-detail-compact {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1rem;
            font-weight: bold;
            color: var(--text);
        }

        /* Chart Container - Стили из trading.html */
        .chart-wrap {
            width: 100%;
            max-width: 760px;
            aspect-ratio: 16/10;
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg);
            border: 1px solid var(--border);
            position: relative;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
            margin: 0 auto 20px;
        }

        .chart {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
        }

        .chart--hidden {
            display: none;
        }

        /* Timer - Стили из trading.html */
        .timerBox {
            width: 100%;
            max-width: 760px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            margin: 20px auto;
        }

        .timerText {
            font-variant-numeric: tabular-nums;
            font-size: 18px;
            font-weight: 800;
            letter-spacing: .5px;
        }

        .bar {
            width: 100%;
            height: 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,.05);
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
        }

        .bar__fill {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 100%;
            background: linear-gradient(90deg, var(--accent2), var(--accent));
            box-shadow: 0 0 12px rgba(123,91,255,.35);
            transition: width .25s linear;
        }

        /* Deal Card - Стили из trading.html */
        .deal {
            width: 100%;
            max-width: 760px;
            background: linear-gradient(180deg, rgba(25,13,20,.75), rgba(20,12,18,.92));
            border: 1px solid rgba(255,92,122,.35);
            border-radius: 14px;
            padding: 16px;
            display: none;
            animation: .35s ease fadeIn;
            box-shadow: 0 10px 30px rgba(255,92,122,.18);
            margin: 20px auto;
        }

        .deal.win {
            background: linear-gradient(180deg, rgba(17,33,28,.75), rgba(14,26,23,.92));
            border: 1px solid rgba(39,224,161,.35);
            box-shadow: 0 10px 30px rgba(39,224,161,.18);
        }

        .deal .h {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 900;
            letter-spacing: .4px;
        }

        .deal .h .dot {
            width: 10px;
            height: 10px;
            background: var(--bad);
            border-radius: 50%;
        }

        .deal.win .h .dot {
            background: var(--good);
        }

        .rows {
            margin-top: 10px;
            display: grid;
            gap: 8px;
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .r {
            background: rgba(255,255,255,.02);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 12px;
        }

        .r .label {
            font-size: 12px;
            color: var(--muted);
        }

        .r .val {
            font-weight: 800;
            font-size: 16px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: none; }
        }

        .fade-in {
            animation: .3s ease fadeIn;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--muted);
            text-transform: uppercase;
        }

        /* Chart Containers */
        .chart-container {
            width: 100%;
            height: 300px;
            position: relative;
        }

        .chart-card {
            grid-column: 1 / -1;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* User Management */
        .users-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            transition: background 0.3s ease;
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .user-details h4 {
            margin-bottom: 5px;
        }

        .user-details p {
            font-size: 0.8rem;
            color: var(--muted);
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        /* ML Management */
        .ml-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .ml-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .ml-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        /* System Controls */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .control-group h3 {
            margin-bottom: 15px;
            color: var(--text);
        }

        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Functions Grid */
        .functions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .function-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
        }

        .function-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .function-icon {
            font-size: 24px;
            margin-bottom: 12px;
            color: var(--primary);
        }

        .function-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }

        .function-desc {
            font-size: 12px;
            color: var(--muted);
        }

        /* Logs */
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-info {
            color: var(--primary);
        }

        .log-success {
            color: var(--secondary);
        }

        .log-warning {
            color: var(--warning);
        }

        .log-error {
            color: var(--danger);
        }

        /* Search */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 45px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: rgba(255, 255, 255, 0.05);
            color: var(--muted);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }

        td {
            color: var(--text);
            font-size: 14px;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .status-active {
            color: var(--secondary);
            font-weight: 600;
        }

        .status-inactive {
            color: var(--danger);
            font-weight: 600;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--secondary);
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.warning {
            background: var(--warning);
        }

        /* Loading and Error States */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--muted);
            text-align: center;
        }

        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-left: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--dark);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--border);
        }

        .modal h3 {
            margin-bottom: 20px;
            color: var(--text);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--muted);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .header-left, .header-right {
                justify-content: center;
            }
            
            .tabs {
                justify-content: center;
            }
            
            .signal-details-compact,
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Notification System -->
    <div id="notification" class="notification"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div id="statusIndicator" class="status-indicator status-offline">
                    <div class="status-dot offline-dot"></div>
                    <span>Bot Offline</span>
                </div>
                <div class="admin-badge">
                    <i class="fas fa-crown"></i> SUPER ADMIN
                </div>
            </div>
            <div class="header-right">
                <button class="btn" onclick="loadAllData()">
                    <i class="fas fa-sync-alt"></i> Обновить
                </button>
                <button class="btn btn-secondary" onclick="switchToUserView()">
                    <i class="fas fa-eye"></i> Вид пользователя
                </button>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Выйти
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('overview')">
                <i class="fas fa-tachometer-alt"></i> Обзор
            </div>
            <div class="tab" onclick="switchTab('users')">
                <i class="fas fa-users"></i> Пользователи
            </div>
            <div class="tab" onclick="switchTab('signals')">
                <i class="fas fa-chart-line"></i> Сигналы
            </div>
            <div class="tab" onclick="switchTab('analytics')">
                <i class="fas fa-chart-bar"></i> Аналитика
            </div>
            <div class="tab" onclick="switchTab('ml')">
                <i class="fas fa-brain"></i> ML Модель
            </div>
            <div class="tab" onclick="switchTab('system')">
                <i class="fas fa-cog"></i> Система
            </div>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <!-- Статистика -->
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-item">
                    <div class="stat-value" id="stat-users">—</div>
                    <div class="stat-label">Активных пользователей</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-accuracy">—%</div>
                    <div class="stat-label">Точность бота</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-trades">—</div>
                    <div class="stat-label">Всего сделок</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-status">—</div>
                    <div class="stat-label">Статус системы</div>
                </div>
            </div>

            <div class="dashboard">
                <!-- Signal Card с графиком и таймером -->
                <div class="card signal-card">
                    <h2><i class="fas fa-satellite-dish"></i> Live Signal</h2>
                    
                    <!-- График -->
                    <div class="chart-wrap">
                        <img id="chartImg" class="chart" alt="chart">
                    </div>

                    <!-- Информация о сигнале -->
                    <div class="signal-details-compact">
                        <div class="signal-detail-compact">
                            <div class="detail-label">Пара</div>
                            <div id="pair" class="detail-value">—</div>
                        </div>
                        <div class="signal-detail-compact">
                            <div class="detail-label">Направление</div>
                            <div id="direction" class="detail-value">—</div>
                        </div>
                        <div class="signal-detail-compact">
                            <div class="detail-label">Вход</div>
                            <div id="entry" class="detail-value">—</div>
                        </div>
                        <div class="signal-detail-compact">
                            <div class="detail-label">Экспирация</div>
                            <div id="expiry" class="detail-value">—</div>
                        </div>
                    </div>

                    <!-- Таймер обратного отсчета -->
                    <div class="timerBox">
                        <div id="timerText" class="timerText">⏳ —:—</div>
                        <div class="bar"><div id="barFill" class="bar__fill" style="width:100%"></div></div>
                    </div>

                    <!-- Карточка завершенной сделки -->
                    <div id="dealCard" class="deal">
                        <div class="h"><span class="dot"></span><span id="dealTitle">СДЕЛКА ЗАВЕРШЕНА</span></div>
                        <div class="rows">
                            <div class="r"><div class="label">Пара</div><div id="d_pair" class="val">—</div></div>
                            <div class="r"><div class="label">Направление</div><div id="d_dir" class="val">—</div></div>
                            <div class="r"><div class="label">Вход</div><div id="d_entry" class="val">—</div></div>
                            <div class="r"><div class="label">Выход</div><div id="d_exit" class="val">—</div></div>
                            <div class="r" style="grid-column:1/-1"><div class="label">Результат</div><div id="d_res" class="val">—</div></div>
                        </div>
                    </div>
                </div>

                <!-- Functions Grid -->
                <div class="card">
                    <h2><i class="fas fa-cogs"></i> Быстрые действия</h2>
                    <div class="functions-grid">
                        <div class="function-card" onclick="switchTab('users')">
                            <div class="function-icon">
                                <i class="fas fa-users-cog"></i>
                            </div>
                            <div class="function-title">Управление пользователями</div>
                            <div class="function-desc">Просмотр, активация, блокировка пользователей</div>
                        </div>
                        
                        <div class="function-card" onclick="sendAdminCommand('retrain', 'Запуск переобучения ML модели...')">
                            <div class="function-icon">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div class="function-title">Обучение ML модели</div>
                            <div class="function-desc">Переобучение нейросети на новых данных</div>
                        </div>
                        
                        <div class="function-card" onclick="switchTab('analytics')">
                            <div class="function-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div class="function-title">Детальная аналитика</div>
                            <div class="function-desc">Статистика по парам и эффективности</div>
                        </div>
                        
                        <div class="function-card" onclick="switchTab('system')">
                            <div class="function-icon">
                                <i class="fas fa-server"></i>
                            </div>
                            <div class="function-title">Системные метрики</div>
                            <div class="function-desc">Мониторинг производительности системы</div>
                        </div>
                        
                        <div class="function-card" onclick="sendAdminCommand('broadcast', 'Форма рассылки...')">
                            <div class="function-icon">
                                <i class="fas fa-bullhorn"></i>
                            </div>
                            <div class="function-title">Рассылка сообщений</div>
                            <div class="function-desc">Отправка уведомлений всем пользователям</div>
                        </div>
                        
                        <div class="function-card" onclick="sendAdminCommand('backup', 'Создание резервной копии...')">
                            <div class="function-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="function-title">Резервное копирование</div>
                            <div class="function-desc">Создание бэкапа базы данных</div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Charts -->
                <div class="card chart-card">
                    <h2><i class="fas fa-chart-pie"></i> Аналитика</h2>
                    <div class="charts-grid">
                        <div class="chart-container">
                            <canvas id="winLossChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="pairsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- System Logs -->
                <div class="card">
                    <h2><i class="fas fa-terminal"></i> Системные логи</h2>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div></div>
                        <button class="btn btn-secondary" onclick="loadSystemLogs()">
                            <i class="fas fa-sync"></i> Обновить
                        </button>
                    </div>
                    <div class="log-container" id="system-logs">
                        <div class="log-entry log-info">Загрузка логов...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-users"></i> Управление пользователями</h2>
                
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Поиск по ID пользователя (например: 5489888474)" oninput="searchUsers(this.value)">
                </div>

                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="showAddUserModal()">
                        <i class="fas fa-plus"></i> Добавить пользователя
                    </button>
                    <button class="btn btn-danger" onclick="bulkRemoveUsers()">
                        <i class="fas fa-ban"></i> Удалить выбранных
                    </button>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-users"></th>
                                <th>ID</th>
                                <th>Имя</th>
                                <th>Регистрация</th>
                                <th>Активность</th>
                                <th>Точность</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr>
                                <td colspan="8" class="loading">
                                    <div class="loading-spinner"></div>
                                    <p>Загрузка пользователей...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Signals Tab -->
        <div id="signals-tab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-chart-line"></i> Активные сигналы</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div></div>
                    <button class="btn btn-danger" onclick="sendAdminCommand('clearalltrades', 'Закрытие всех сделок...')">
                        <i class="fas fa-times"></i> Закрыть все сделки
                    </button>
                </div>
                <div id="adminSignalsContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Загрузка активных сигналов...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-chart-bar"></i> Эффективность по парам</h2>
                <div class="chart-container">
                    <canvas id="pairsAnalyticsChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-brain"></i> Статистика ML модели</h2>
                <div class="chart-container">
                    <canvas id="mlAnalyticsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ML Tab -->
        <div id="ml-tab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-brain"></i> Управление ML Моделью</h2>
                
                <div class="ml-info">
                    <h3>Текущее состояние модели</h3>
                    <div class="ml-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="ml-accuracy">—%</div>
                            <div class="stat-label">Текущая точность</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="ml-trades">—</div>
                            <div class="stat-label">Обучение на сделках</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="ml-version">v3.2.1</div>
                            <div class="stat-label">Версия модели</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="ml-status">—</div>
                            <div class="stat-label">Статус</div>
                        </div>
                    </div>
                </div>

                <div class="ml-controls">
                    <div class="function-card" onclick="sendAdminCommand('retrain', 'Запуск переобучения ML модели...')">
                        <div class="function-icon">
                            <i class="fas fa-retweet"></i>
                        </div>
                        <div class="function-title">Переобучить модель</div>
                        <div class="function-desc">Обучение на новых данных</div>
                    </div>
                    
                    <div class="function-card" onclick="sendAdminCommand('forceml', 'Принудительное включение ML...')">
                        <div class="function-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="function-title">Принудительно включить ML</div>
                        <div class="function-desc">Активация ML функций</div>
                    </div>
                    
                    <div class="function-card" onclick="sendAdminCommand('repairml', 'Восстановление ML...')">
                        <div class="function-icon">
                            <i class="fas fa-tools"></i>
                        </div>
                        <div class="function-title">Восстановить ML</div>
                        <div class="function-desc">Ремонт ML фичей</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Tab -->
        <div id="system-tab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-cog"></i> Системные команды</h2>
                
                <div class="controls-grid">
                    <div class="control-group">
                        <h3>Основные операции</h3>
                        <div class="control-buttons">
                            <button class="btn btn-danger" onclick="sendAdminCommand('stop', 'Остановка бота...')">
                                <i class="fas fa-power-off"></i> Остановить бота
                            </button>
                            <button class="btn btn-warning" onclick="sendAdminCommand('restart', 'Перезапуск бота...')">
                                <i class="fas fa-redo"></i> Перезапустить бота
                            </button>
                            <button class="btn" onclick="sendAdminCommand('checkdata', 'Проверка данных...')">
                                <i class="fas fa-check-circle"></i> Проверить данные
                            </button>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Управление данными</h3>
                        <div class="control-buttons">
                            <button class="btn btn-danger" onclick="sendAdminCommand('clearalltrades', 'Очистка всех сделок...')">
                                <i class="fas fa-trash"></i> Очистить все сделки
                            </button>
                            <button class="btn btn-warning" onclick="sendAdminCommand('restorecounter', 'Восстановление счетчиков...')">
                                <i class="fas fa-undo"></i> Восстановить счетчики
                            </button>
                            <button class="btn" onclick="sendAdminCommand('cleartrade', 'Очистка активной сделки...')">
                                <i class="fas fa-times"></i> Очистить активную сделку
                            </button>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Резервное копирование</h3>
                        <div class="control-buttons">
                            <button class="btn btn-success" onclick="sendAdminCommand('backup', 'Создание резервной копии...')">
                                <i class="fas fa-database"></i> Создать бэкап
                            </button>
                            <button class="btn" onclick="sendAdminCommand('restorebackup', 'Восстановление из бэкапа...')">
                                <i class="fas fa-history"></i> Восстановить из бэкапа
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-user-plus"></i> Добавить пользователя</h3>
            <div class="form-group">
                <label for="userPocketId">Pocket Option ID:</label>
                <input type="text" id="userPocketId" placeholder="Введите Pocket ID">
            </div>
            <div class="form-group">
                <label for="userName">Имя пользователя:</label>
                <input type="text" id="userName" placeholder="Введите имя">
            </div>
            <div class="form-group">
                <label for="userTelegramId">Telegram ID (опционально):</label>
                <input type="text" id="userTelegramId" placeholder="Введите Telegram ID">
            </div>
            <div class="form-group">
                <label for="userRole">Роль:</label>
                <select id="userRole">
                    <option value="user">Пользователь</option>
                    <option value="admin">Администратор</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Отмена</button>
                <button class="btn btn-success" onclick="addUser()">Добавить</button>
            </div>
        </div>
    </div>

    // Конфигурация
const BASE_URL = 'https://nonurban-joella-unvagrantly.ngrok-free.dev';
let appState = {
    isOnline: false,
    charts: {},
    currentTab: 'overview',
    users: [],
    // Состояние для графика и таймера
    lastSignalTs: 0,
    lastTradeIdShown: null,
    timerInt: null,
    totalMs: 0,
    expiryMs: 0,
};

// Уведомления
function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type} show`;
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 4000);
}

// Навигация по вкладкам
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

    document.getElementById(`${tabName}-tab`).classList.add('active');
    document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
    
    appState.currentTab = tabName;
    
    switch(tabName) {
        case 'users':
            loadUsersTable();
            break;
        case 'signals':
            loadAdminSignals();
            break;
        case 'analytics':
            loadAnalyticsCharts();
            break;
        case 'ml':
            loadMLData();
            break;
    }
}

// Функции для графика и таймера (из trading.html)
const pad = x => String(x).padStart(2,'0');
const fmt = n => (n===null||n===undefined) ? "—" : (typeof n==="number" ? (Math.abs(n) >= 1 ? n.toFixed(5) : n.toPrecision(6)) : n);

function setChartVisible(v){
    const img = document.getElementById('chartImg');
    if(v) img.classList.remove('chart--hidden'); 
    else img.classList.add('chart--hidden');
}

function setDealVisible(v, isWin=false){
    const card = document.getElementById('dealCard');
    if(v){
        card.style.display = 'block';
        card.classList.add('fade-in');
        isWin ? card.classList.add('win') : card.classList.remove('win');
    }else{
        card.style.display = 'none';
        card.classList.remove('win');
    }
}

function startTimer(createdTs, expiryMinutes){
    clearInterval(appState.timerInt);

    if(!createdTs || !expiryMinutes){
        document.getElementById('timerText').textContent = '⏳ —:—';
        document.getElementById('barFill').style.width = '0%';
        return;
    }

    const createdMs = (typeof createdTs === 'number') ? createdTs : new Date(createdTs).getTime();
    const expiryMs  = createdMs + (expiryMinutes * 60 * 1000);
    const totalMs   = Math.max(1, expiryMs - createdMs);

    appState.expiryMs = expiryMs;
    appState.totalMs  = totalMs;

    const tick = () => {
        const now = Date.now();
        const rem = Math.max(0, expiryMs - now);
        const mm = Math.floor(rem/1000/60);
        const ss = Math.floor(rem/1000) % 60;
        document.getElementById('timerText').textContent = `⏳ Осталось: ${pad(mm)}:${pad(ss)}`;

        const pct = Math.max(0, Math.min(100, (rem / totalMs) * 100));
        document.getElementById('barFill').style.width = `${pct}%`;

        if(rem<=0){
            clearInterval(appState.timerInt);
        }
    };

    tick();
    appState.timerInt = setInterval(tick, 250);
}

// Рендер сигнала
function renderSignal(sig, chartBase64){
    setDealVisible(false);
    setChartVisible(true);

    document.getElementById('pair').textContent = sig?.pair ?? '—';

    const dir = String(sig?.direction||'—').toUpperCase();
    const dirEl = document.getElementById('direction');
    dirEl.textContent = dir;
    dirEl.className = 'detail-value';
    if(dir==='BUY') dirEl.classList.add('signal-buy');
    if(dir==='SELL') dirEl.classList.add('signal-sell');

    document.getElementById('entry').textContent = fmt(sig?.entry_price ?? sig?.entry);

    const createdTs = sig?.timestamp ?? sig?.created_at ?? Date.now();
    const expMin    = sig?.expiry ?? sig?.expiry_minutes ?? null;
    if(createdTs && expMin){
        const expAt = new Date((typeof createdTs==='number'?createdTs:new Date(createdTs).getTime()) + expMin*60*1000);
        document.getElementById('expiry').textContent = expAt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        startTimer(createdTs, expMin);
    }else{
        document.getElementById('expiry').textContent = '—';
        startTimer(null, null);
    }

    if(chartBase64){
        document.getElementById('chartImg').src = chartBase64.startsWith("data:image") 
            ? chartBase64 
            : `data:image/png;base64,${chartBase64}`;
    }
}

function renderCompleted(res){
    const id   = res?.trade_id ?? '—';
    const pair = res?.pair ?? '—';
    const dir  = res?.direction ? String(res.direction).toUpperCase() : '—';
    const entry= res?.entry_price ?? res?.entry ?? '—';
    const exit = res?.exit_price  ?? res?.exit  ?? '—';
    const result = (res?.result || '—').toUpperCase();

    const prefix = (result==='WIN') ? '🟢 СДЕЛКА #' : '🔴 СДЕЛКА #';
    document.getElementById('dealTitle').textContent = `${prefix}${id} ЗАВЕРШЕНА`;

    document.getElementById('d_pair').textContent  = pair;
    document.getElementById('d_dir').textContent   = dir;
    document.getElementById('d_entry').textContent = fmt(entry);
    document.getElementById('d_exit').textContent  = fmt(exit);
    document.getElementById('d_res').textContent   = result;

    setChartVisible(false);
    setDealVisible(true, result==='WIN');

    clearInterval(appState.timerInt);
    document.getElementById('timerText').textContent = '⏳ —:—';
    document.getElementById('barFill').style.width = '0%';
}

// Загрузка всех данных - ИСПРАВЛЕННАЯ ВЕРСИЯ
async function loadAllData() {
    try {
        console.log('Загрузка данных с:', BASE_URL);
        
        const [systemData, signalData, usersData] = await Promise.allSettled([
            fetch(`${BASE_URL}/api/system_status.json`, {cache: 'no-store'}).then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.json();
            }),
            fetch(`${BASE_URL}/api/latest_full.json`, {cache: 'no-store'}).then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.json();
            }),
            fetch(`${BASE_URL}/pocket_users.json`, {cache: 'no-store'}).then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.json();
            })
        ]);

        console.log('Полученные данные:', { systemData, signalData, usersData });

        // Обновляем статус системы
        if (systemData.status === 'fulfilled') {
            await handleSystemData(systemData.value);
        } else {
            console.error('Ошибка system_data:', systemData.reason);
        }

        // Обновляем сигналы и графики
        if (signalData.status === 'fulfilled') {
            await handleSignalData(signalData.value);
        } else {
            console.error('Ошибка signal_data:', signalData.reason);
        }

        // Обновляем данные пользователей
        if (usersData.status === 'fulfilled') {
            await handleUsersData(usersData.value);
        } else {
            console.error('Ошибка users_data:', usersData.reason);
            // Пробуем альтернативный путь
            try {
                const altUsers = await fetch(`${BASE_URL}/api/pocket_users.json`, {cache: 'no-store'}).then(r => r.json());
                await handleUsersData(altUsers);
            } catch (e) {
                console.error('Альтернативный путь тоже не сработал:', e);
            }
        }

        appState.isOnline = true;
        updateStatusIndicator(true);

    } catch (error) {
        console.error('Общая ошибка загрузки:', error);
        handleError('Ошибка соединения с сервером');
        appState.isOnline = false;
        updateStatusIndicator(false);
    }
}

// Обработка данных системы
async function handleSystemData(data) {
    console.log('Данные системы:', data);
    
    // Обновляем статистику
    const totalUsers = data.total_users || data.active_users || 0;
    const winRate = data.win_rate || data.accuracy || 0;
    const totalTrades = data.total_trades || 0;
    const botStatus = data.bot_status || data.status || 'unknown';

    document.getElementById('stat-users').textContent = totalUsers;
    document.getElementById('stat-accuracy').textContent = `${winRate}%`;
    document.getElementById('stat-trades').textContent = totalTrades;
    
    // Определяем статус системы
    let statusText = 'Неизвестно';
    let statusLabel = 'Статус не определен';
    
    if (botStatus === 'running' || botStatus === 'active') {
        statusText = 'Работает';
        statusLabel = 'Система активна';
    } else if (botStatus === 'stopped' || botStatus === 'inactive') {
        statusText = 'Остановлен';
        statusLabel = 'Система остановлена';
    } else {
        // Проверяем наличие активных пользователей как индикатор работы
        if (totalUsers > 0) {
            statusText = 'Работает';
            statusLabel = `${totalUsers} активных пользователей`;
        } else {
            statusText = 'Нет активных';
            statusLabel = 'Ожидание пользователей';
        }
    }
    
    document.getElementById('stat-status').textContent = statusText;
    
    // Обновляем аналитику
    updateAnalyticsCharts(data);
}

// Обработка данных сигналов
async function handleSignalData(data) {
    console.log('Данные сигналов:', data);
    
    const sig = data?.signal || null;
    const res = data?.result || null;
    const chartB64 = data?.chart_base64 || null;

    let showSignal = false;
    if(sig && sig.pair){
        const created = sig?.timestamp ?? sig?.created_at ?? null;
        const expMin  = sig?.expiry ?? sig?.expiry_minutes ?? null;
        if(created && expMin){
            const createdMs = (typeof created==='number') ? created : new Date(created).getTime();
            const expMs = createdMs + expMin*60*1000;
            showSignal = expMs > Date.now();
        } else {
            // Если нет времени экспирации, но есть сигнал - показываем его
            showSignal = true;
        }
    }

    if(showSignal){
        const stamp = sig?.timestamp ? (typeof sig.timestamp==='number' ? sig.timestamp : new Date(sig.timestamp).getTime())
                                     : (sig?.created_at ? new Date(sig.created_at).getTime() : Date.now());
        if (stamp !== appState.lastSignalTs){
            appState.lastSignalTs = stamp;
            renderSignal(sig, chartB64);
        }
    }else if(res && res.trade_id){
        if(res.trade_id !== appState.lastTradeIdShown){
            appState.lastTradeIdShown = res.trade_id;
            renderCompleted(res);
        }
    } else {
        // Нет активного сигнала и нет завершенной сделки
        setDealVisible(false);
        setChartVisible(false);
        clearInterval(appState.timerInt);
        document.getElementById('timerText').textContent = '⏳ Ожидание сигнала';
        document.getElementById('barFill').style.width = '0%';
    }
}

// Обработка данных пользователей
async function handleUsersData(data) {
    console.log('Данные пользователей:', data);
    
    if (!data) {
        console.log('Нет данных пользователей');
        return;
    }

    // Обрабатываем разные форматы данных
    let users = [];
    
    if (Array.isArray(data)) {
        users = data;
    } else if (data.users && Array.isArray(data.users)) {
        users = data.users;
    } else if (typeof data === 'object') {
        // Формат { "user_id": { user_data }, ... }
        users = Object.entries(data).map(([id, userData]) => ({
            id: id,
            ...userData
        }));
    }

    appState.users = users;
    
    // Обновляем статистику пользователей
    const activeUsers = users.filter(user => 
        user.status === 'active' || user.is_active || user.last_activity
    ).length;

    // Обновляем счетчик пользователей в статистике
    document.getElementById('stat-users').textContent = activeUsers || users.length;
    
    // Если на вкладке пользователей - обновляем таблицу
    if (appState.currentTab === 'users') {
        renderUsersTable();
    }
}

// Обновление интерфейса
function updateStatusIndicator(isOnline) {
    const indicator = document.getElementById('statusIndicator');
    if (isOnline) {
        indicator.className = 'status-indicator status-online';
        indicator.innerHTML = '<div class="status-dot online-dot"></div><span>Bot Online</span>';
    } else {
        indicator.className = 'status-indicator status-offline';
        indicator.innerHTML = '<div class="status-dot offline-dot"></div><span>Bot Offline</span>';
    }
}

function updateAnalyticsCharts(data) {
    // Win/Loss Chart
    const winLossCtx = document.getElementById('winLossChart').getContext('2d');
    if (appState.charts.winLoss) {
        appState.charts.winLoss.destroy();
    }
    
    const winRate = data.win_rate || 50;
    appState.charts.winLoss = new Chart(winLossCtx, {
        type: 'doughnut',
        data: {
            labels: ['Выигрыши', 'Проигрыши'],
            datasets: [{
                data: [winRate, 100 - winRate],
                backgroundColor: ['#10b981', '#ef4444'],
                borderWidth: 2,
                borderColor: '#1f2937'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#f3f4f6',
                        font: { size: 12 }
                    }
                }
            }
        }
    });

    // Pairs Chart
    const pairsCtx = document.getElementById('pairsChart').getContext('2d');
    if (appState.charts.pairs) {
        appState.charts.pairs.destroy();
    }
    
    // Используем реальные данные если есть, иначе демо-данные
    const pairsData = data.pairs_performance || {
        'EURUSD': 25,
        'GBPUSD': 18, 
        'USDJPY': 15,
        'AUDUSD': 12,
        'USDCAD': 10,
        'Others': 20
    };

    appState.charts.pairs = new Chart(pairsCtx, {
        type: 'pie',
        data: {
            labels: Object.keys(pairsData),
            datasets: [{
                data: Object.values(pairsData),
                backgroundColor: [
                    '#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6b7280'
                ],
                borderWidth: 2,
                borderColor: '#1f2937'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#f3f4f6',
                        font: { size: 11 }
                    }
                }
            }
        }
    });
}

// Управление пользователями
async function loadUsersTable() {
    try {
        // Если пользователи уже загружены, используем их
        if (appState.users.length > 0) {
            renderUsersTable();
            return;
        }

        // Иначе загружаем заново
        const response = await fetch(`${BASE_URL}/pocket_users.json`, {cache: 'no-store'});
        if (!response.ok) throw new Error('Failed to load users');
        
        const data = await response.json();
        await handleUsersData(data);

    } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTable').innerHTML = `
            <tr>
                <td colspan="8" class="error">
                    <p>Ошибка загрузки пользователей: ${error.message}</p>
                    <button class="btn btn-secondary" onclick="loadUsersTable()" style="margin-top: 10px;">
                        Попробовать снова
                    </button>
                </td>
            </tr>
        `;
    }
}

function renderUsersTable() {
    const container = document.getElementById('usersTable');
    
    if (!appState.users || appState.users.length === 0) {
        container.innerHTML = `
            <tr>
                <td colspan="8" class="loading">
                    <i class="fas fa-users"></i>
                    <p>Пользователи не найдены</p>
                </td>
            </tr>
        `;
        return;
    }

    let usersHTML = '';
    
    appState.users.forEach(user => {
        const isActive = user.status === 'active' || user.is_active || user.last_activity;
        const lastActivity = user.last_activity ? 
            new Date(user.last_activity).toLocaleDateString('ru-RU') : 
            'Неизвестно';
        
        usersHTML += `
            <tr>
                <td><input type="checkbox" data-user-id="${user.id}"></td>
                <td>${user.id || '—'}</td>
                <td>${user.name || user.username || '—'}</td>
                <td>${user.registered_at ? new Date(user.registered_at).toLocaleDateString('ru-RU') : '—'}</td>
                <td>${lastActivity}</td>
                <td>${user.accuracy || user.win_rate || 0}%</td>
                <td class="${isActive ? 'status-active' : 'status-inactive'}">
                    ${isActive ? 'Активен' : 'Неактивен'}
                </td>
                <td>
                    <button class="btn btn-small" onclick="manageUser('${user.id}')">
                        <i class="fas fa-cog"></i>
                    </button>
                </td>
            </tr>
        `;
    });



        // Модальное окно пользователя
        function showAddUserModal() {
            document.getElementById('addUserModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('addUserModal').style.display = 'none';
        }

        async function addUser() {
            const pocketId = document.getElementById('userPocketId').value;
            const name = document.getElementById('userName').value;
            const telegramId = document.getElementById('userTelegramId').value;
            const role = document.getElementById('userRole').value;

            if (!pocketId || !name) {
                showNotification('Заполните все обязательные поля', 'error');
                return;
            }

            await sendAdminCommand(`add_user ${pocketId}`, `Добавление пользователя ${name}...`);
            closeModal();
            
            document.getElementById('userPocketId').value = '';
            document.getElementById('userName').value = '';
            document.getElementById('userTelegramId').value = '';
        }

        function bulkRemoveUsers() {
            const selectedUsers = Array.from(document.querySelectorAll('#usersTable input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.closest('tr').querySelector('td:nth-child(2)').textContent);
            
            if (selectedUsers.length === 0) {
                showNotification('Выберите пользователей для удаления', 'warning');
                return;
            }
            
            if (confirm(`Удалить ${selectedUsers.length} пользователей из системы?`)) {
                sendAdminCommand(`remove_users ${selectedUsers.join(',')}`, `Удаление пользователей...`);
            }
        }

        // Сигналы
        async function loadAdminSignals() {
            const container = document.getElementById('adminSignalsContainer');
            
            try {
                const response = await fetch(`${BASE_URL}/api/last_signal.json`);
                const signal = await response.json();
                
                if (signal.error || !signal.pair) {
                    container.innerHTML = '<div class="error">Нет активных сигналов</div>';
                    return;
                }
                
                container.innerHTML = `
                    <div class="card signal-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>${signal.pair} - ${signal.direction}</h3>
                            <span class="status-active">Уверенность: ${signal.confidence}/10</span>
                        </div>
                        <div class="signal-details-compact">
                            <div class="signal-detail-compact">
                                <div class="detail-label">Пара</div>
                                <div class="detail-value">${signal.pair}</div>
                            </div>
                            <div class="signal-detail-compact">
                                <div class="detail-label">Направление</div>
                                <div class="detail-value" style="color: ${signal.direction === 'BUY' ? 'var(--good)' : 'var(--bad)'};">${signal.direction}</div>
                            </div>
                            <div class="signal-detail-compact">
                                <div class="detail-label">Цена входа</div>
                                <div class="detail-value">${signal.entry_price || '—'}</div>
                            </div>
                            <div class="signal-detail-compact">
                                <div class="detail-label">Экспирация</div>
                                <div class="detail-value">${signal.expiry || '—'} мин</div>
                            </div>
                        </div>
                        <button class="btn btn-danger" style="width: 100%; margin-top: 15px;" onclick="sendAdminCommand('cleartrade', 'Очистка активной сделки...')">
                            <i class="fas fa-times"></i> Принудительно закрыть сделку
                        </button>
                    </div>
                `;
                
            } catch (error) {
                container.innerHTML = `<div class="error">Ошибка загрузки сигналов: ${error.message}</div>`;
            }
        }

        // Аналитика
        function loadAnalyticsCharts() {
            const pairsCtx = document.getElementById('pairsAnalyticsChart').getContext('2d');
            new Chart(pairsCtx, {
                type: 'bar',
                data: {
                    labels: ['EURUSD', 'GBPUSD', 'USDJPY', 'AUDCHF', 'GBPCHF'],
                    datasets: [{
                        label: 'Точность %',
                        data: [76.6, 73.5, 78.2, 71.1, 68.9],
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(139, 92, 246, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            const mlCtx = document.getElementById('mlAnalyticsChart').getContext('2d');
            new Chart(mlCtx, {
                type: 'line',
                data: {
                    labels: ['Янв 10', 'Янв 11', 'Янв 12', 'Янв 13', 'Янв 14', 'Янв 15'],
                    datasets: [{
                        label: 'Точность ML %',
                        data: [72.1, 74.3, 75.8, 76.2, 77.5, 78.3],
                        borderColor: 'rgba(16, 185, 129, 0.8)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // ML данные
        function loadMLData() {
            document.getElementById('ml-accuracy').textContent = '78.3%';
            document.getElementById('ml-trades').textContent = '1,247';
            document.getElementById('ml-status').textContent = 'Активна';
        }

        // Системные логи
        async function loadSystemLogs() {
            const container = document.getElementById('system-logs');
            container.innerHTML = '<div class="log-entry log-info">Загрузка логов...</div>';
            
            setTimeout(() => {
                container.innerHTML = `
                    <div class="log-entry log-info">[INFO] ${new Date().toLocaleString()} - Система работает стабильно</div>
                    <div class="log-entry log-success">[SUCCESS] ${new Date().toLocaleString()} - Данные успешно обновлены</div>
                    <div class="log-entry log-warning">[WARNING] ${new Date().toLocaleString()} - Проверьте подключение к MT5</div>
                    <div class="log-entry log-info">[INFO] ${new Date().toLocaleString()} - Активных пользователей: 15</div>
                `;
            }, 1000);
        }

        // Команды админа
        async function sendAdminCommand(command, message) {
            showNotification(message, 'warning');
            
            try {
                await new Promise(resolve => setTimeout(resolve, 2000));
                showNotification(`Команда "${command}" выполнена успешно`, 'success');
                loadAllData();
                
            } catch (error) {
                showNotification(`Ошибка выполнения команды: ${error.message}`, 'error');
            }
        }

        // Вспомогательные функции
        function searchUsers(query) {
            if (query.length >= 3) {
                console.log(`Поиск пользователей: ${query}`);
            }
        }

        function manageUser(userId) {
            alert(`Управление пользователем ${userId}`);
        }

        function switchToUserView() {
            window.open('/trading.html', '_blank');
        }

        function logout() {
            if (confirm('Вы уверены, что хотите выйти?')) {
                showNotification('Выход из системы...', 'info');
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 1000);
            }
        }

        function showLoadingState() {
            // Уже есть индикаторы загрузки в интерфейсе
        }

        function handleError(message) {
            showNotification(message, 'error');
            updateStatusIndicator(false);
        }

        // Инициализация
function init() {
    loadAllData();
    setInterval(loadAllData, 5000); // Обновление каждые 5 секунд
    
    window.addEventListener('click', (e) => {
        if (e.target === document.getElementById('addUserModal')) {
            closeModal();
        }
    });
}

document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
